/**\n * 第一阶段：AI 消除 - EditTask 数据库模型\n * \n * 功能：\n * - 定义 EditTask 类型\n * - 提供数据库操作函数\n * - 支持 Supabase 集成\n * \n * 作者：Manus AI\n * 日期：2025-01-13\n */\n\nimport { createClient } from '@supabase/supabase-js';\n\n// ============ 类型定义 ============\n\nexport type TaskType = 'inpaint' | 'expand' | 'beautify' | 'batch' | 'pose';\n\nexport type TaskStatus =\n  | 'queued'\n  | 'validating'\n  | 'preprocessing'\n  | 'processing'\n  | 'postprocessing'\n  | 'completed'\n  | 'failed'\n  | 'cancelled';\n\nexport interface ImageSize {\n  width: number;\n  height: number;\n}\n\nexport interface ProcessingParams {\n  [key: string]: any;\n  refinement_steps?: number;\n  quality?: number;\n  seed?: number;\n}\n\nexport interface EditTask {\n  id: string;\n  user_id: string;\n  task_type: TaskType;\n  status: TaskStatus;\n  progress: number;\n  original_image_url: string;\n  mask_image_url?: string;\n  result_image_url?: string;\n  image_size?: ImageSize;\n  processing_params?: ProcessingParams;\n  processing_time_ms?: number;\n  worker_id?: number;\n  error_message?: string;\n  created_at: string;\n  started_at?: string;\n  completed_at?: string;\n  updated_at: string;\n}\n\nexport interface CreateEditTaskInput {\n  user_id: string;\n  task_type: TaskType;\n  original_image_url: string;\n  mask_image_url?: string;\n  processing_params?: ProcessingParams;\n}\n\nexport interface UpdateEditTaskInput {\n  status?: TaskStatus;\n  progress?: number;\n  result_image_url?: string;\n  image_size?: ImageSize;\n  processing_time_ms?: number;\n  worker_id?: number;\n  error_message?: string;\n  started_at?: string;\n  completed_at?: string;\n}\n\n// ============ 数据库操作类 ============\n\nexport class EditTaskRepository {\n  private supabase;\n  private tableName = 'edit_tasks';\n\n  constructor(supabaseUrl: string, supabaseKey: string) {\n    this.supabase = createClient(supabaseUrl, supabaseKey);\n  }\n\n  /**\n   * 创建新任务\n   */\n  async createTask(input: CreateEditTaskInput): Promise<EditTask> {\n    const { data, error } = await this.supabase\n      .from(this.tableName)\n      .insert([\n        {\n          user_id: input.user_id,\n          task_type: input.task_type,\n          status: 'queued',\n          progress: 0,\n          original_image_url: input.original_image_url,\n          mask_image_url: input.mask_image_url,\n          processing_params: input.processing_params,\n        },\n      ])\n      .select()\n      .single();\n\n    if (error) {\n      throw new Error(`Failed to create task: ${error.message}`);\n    }\n\n    return data as EditTask;\n  }\n\n  /**\n   * 获取任务\n   */\n  async getTask(taskId: string): Promise<EditTask | null> {\n    const { data, error } = await this.supabase\n      .from(this.tableName)\n      .select('*')\n      .eq('id', taskId)\n      .single();\n\n    if (error) {\n      if (error.code === 'PGRST116') {\n        // 任务不存在\n        return null;\n      }\n      throw new Error(`Failed to get task: ${error.message}`);\n    }\n\n    return data as EditTask;\n  }\n\n  /**\n   * 更新任务\n   */\n  async updateTask(taskId: string, input: UpdateEditTaskInput): Promise<EditTask> {\n    const { data, error } = await this.supabase\n      .from(this.tableName)\n      .update(input)\n      .eq('id', taskId)\n      .select()\n      .single();\n\n    if (error) {\n      throw new Error(`Failed to update task: ${error.message}`);\n    }\n\n    return data as EditTask;\n  }\n\n  /**\n   * 获取用户的所有任务\n   */\n  async getUserTasks(\n    userId: string,\n    options?: {\n      limit?: number;\n      offset?: number;\n      taskType?: TaskType;\n      status?: TaskStatus;\n    }\n  ): Promise<{ tasks: EditTask[]; total: number }> {\n    let query = this.supabase\n      .from(this.tableName)\n      .select('*', { count: 'exact' })\n      .eq('user_id', userId);\n\n    if (options?.taskType) {\n      query = query.eq('task_type', options.taskType);\n    }\n\n    if (options?.status) {\n      query = query.eq('status', options.status);\n    }\n\n    query = query.order('created_at', { ascending: false });\n\n    if (options?.limit) {\n      query = query.limit(options.limit);\n    }\n\n    if (options?.offset) {\n      query = query.range(options.offset, options.offset + (options.limit || 10) - 1);\n    }\n\n    const { data, error, count } = await query;\n\n    if (error) {\n      throw new Error(`Failed to get user tasks: ${error.message}`);\n    }\n\n    return {\n      tasks: data as EditTask[],\n      total: count || 0,\n    };\n  }\n\n  /**\n   * 获取用户的最近完成的任务\n   */\n  async getUserRecentTasks(userId: string, limit: number = 10): Promise<EditTask[]> {\n    const { data, error } = await this.supabase\n      .from(this.tableName)\n      .select('*')\n      .eq('user_id', userId)\n      .eq('status', 'completed')\n      .order('completed_at', { ascending: false })\n      .limit(limit);\n\n    if (error) {\n      throw new Error(`Failed to get recent tasks: ${error.message}`);\n    }\n\n    return data as EditTask[];\n  }\n\n  /**\n   * 获取统计信息\n   */\n  async getStatistics(userId: string): Promise<any> {\n    const { data, error } = await this.supabase\n      .from('task_statistics')\n      .select('*')\n      .eq('user_id', userId);\n\n    if (error) {\n      throw new Error(`Failed to get statistics: ${error.message}`);\n    }\n\n    return data;\n  }\n\n  /**\n   * 删除任务\n   */\n  async deleteTask(taskId: string): Promise<void> {\n    const { error } = await this.supabase\n      .from(this.tableName)\n      .delete()\n      .eq('id', taskId);\n\n    if (error) {\n      throw new Error(`Failed to delete task: ${error.message}`);\n    }\n  }\n\n  /**\n   * 批量更新任务状态\n   */\n  async updateTasksStatus(taskIds: string[], status: TaskStatus): Promise<void> {\n    const { error } = await this.supabase\n      .from(this.tableName)\n      .update({ status })\n      .in('id', taskIds);\n\n    if (error) {\n      throw new Error(`Failed to update tasks status: ${error.message}`);\n    }\n  }\n\n  /**\n   * 获取待处理的任务\n   */\n  async getPendingTasks(limit: number = 10): Promise<EditTask[]> {\n    const { data, error } = await this.supabase\n      .from(this.tableName)\n      .select('*')\n      .eq('status', 'queued')\n      .order('created_at', { ascending: true })\n      .limit(limit);\n\n    if (error) {\n      throw new Error(`Failed to get pending tasks: ${error.message}`);\n    }\n\n    return data as EditTask[];\n  }\n}\n\n// ============ 导出 ============\n\nexport default EditTaskRepository;\n
