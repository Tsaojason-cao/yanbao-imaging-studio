/**\n * GLSL 着色器管理器 - Shader Manager\n * \n * 功能：\n * - 加载和编译 GLSL 着色器\n * - 管理着色器程序\n * - 设置 uniform 变量\n * - 性能监控\n * \n * 作者：Manus AI\n * 日期：2025-01-13\n */\n\nimport { GLContext, Texture } from 'expo-gl';\n\n// ============ 类型定义 ============\n\nexport interface ShaderProgram {\n  id: WebGLProgram;\n  vertexShader: WebGLShader;\n  fragmentShader: WebGLShader;\n  uniforms: Map<string, WebGLUniformLocation>;\n  attributes: Map<string, GLint>;\n}\n\nexport interface BeautyShaderParams {\n  smoothing: number;        // 磨皮强度 (0.0 - 1.0)\n  saturation: number;       // 饱和度 (0.0 - 2.0)\n  brightness: number;       // 亮度 (0.0 - 2.0)\n  warmth: number;           // 暖色调 (-1.0 - 1.0)\n  eyeBrightness: number;    // 亮眼强度 (0.0 - 2.0)\n  eyeContrast: number;      // 眼睛对比度 (0.0 - 2.0)\n  faceThinning: number;     // 瘦脸强度 (0.0 - 1.0)\n  blurRadius: number;       // 模糊半径 (1.0 - 10.0)\n}\n\nexport interface ShaderPerformance {\n  compilationTime: number;  // 编译时间（毫秒）\n  renderTime: number;       // 渲染时间（毫秒）\n  fps: number;              // 帧率\n}\n\n// ============ 常量 ============\n\nconst VERTEX_SHADER_SOURCE = `\n  attribute vec2 aPosition;\n  attribute vec2 aTexCoord;\n  \n  varying vec2 vTexCoord;\n  \n  void main() {\n    gl_Position = vec4(aPosition, 0.0, 1.0);\n    vTexCoord = aTexCoord;\n  }\n`;\n\n// ============ Shader Manager 类 ============\n\nexport class ShaderManager {\n  private gl: WebGLRenderingContext;\n  private programs: Map<string, ShaderProgram> = new Map();\n  private performance: ShaderPerformance = {\n    compilationTime: 0,\n    renderTime: 0,\n    fps: 0,\n  };\n  private frameCount: number = 0;\n  private lastTime: number = Date.now();\n\n  constructor(gl: WebGLRenderingContext) {\n    this.gl = gl;\n  }\n\n  /**\n   * 编译着色器\n   */\n  private compileShader(source: string, type: GLenum): WebGLShader | null {\n    const shader = this.gl.createShader(type);\n    if (!shader) return null;\n\n    this.gl.shaderSource(shader, source);\n    this.gl.compileShader(shader);\n\n    if (!this.gl.getShaderParameter(shader, this.gl.COMPILE_STATUS)) {\n      console.error('Shader compilation error:', this.gl.getShaderInfoLog(shader));\n      this.gl.deleteShader(shader);\n      return null;\n    }\n\n    return shader;\n  }\n\n  /**\n   * 创建着色器程序\n   */\n  createProgram(name: string, fragmentShaderSource: string): ShaderProgram | null {\n    const startTime = performance.now();\n\n    // 编译顶点着色器\n    const vertexShader = this.compileShader(VERTEX_SHADER_SOURCE, this.gl.VERTEX_SHADER);\n    if (!vertexShader) return null;\n\n    // 编译片段着色器\n    const fragmentShader = this.compileShader(fragmentShaderSource, this.gl.FRAGMENT_SHADER);\n    if (!fragmentShader) {\n      this.gl.deleteShader(vertexShader);\n      return null;\n    }\n\n    // 链接程序\n    const program = this.gl.createProgram();\n    if (!program) return null;\n\n    this.gl.attachShader(program, vertexShader);\n    this.gl.attachShader(program, fragmentShader);\n    this.gl.linkProgram(program);\n\n    if (!this.gl.getProgramParameter(program, this.gl.LINK_STATUS)) {\n      console.error('Program linking error:', this.gl.getProgramInfoLog(program));\n      this.gl.deleteProgram(program);\n      return null;\n    }\n\n    const compilationTime = performance.now() - startTime;\n    this.performance.compilationTime = compilationTime;\n\n    // 获取 uniform 和 attribute 位置\n    const uniforms = new Map<string, WebGLUniformLocation>();\n    const attributes = new Map<string, GLint>();\n\n    // 获取常用的 uniform\n    const uniformNames = [\n      'uTexture',\n      'uResolution',\n      'uSmoothingStrength',\n      'uBlurRadius',\n      'uSaturation',\n      'uBrightness',\n      'uWarmth',\n      'uEyeMask',\n      'uEyeBrightness',\n      'uEyeContrast',\n      'uFaceMask',\n      'uThinningStrength',\n      'uFaceCenter',\n      'uFaceRadius',\n    ];\n\n    for (const name of uniformNames) {\n      const location = this.gl.getUniformLocation(program, name);\n      if (location !== null) {\n        uniforms.set(name, location);\n      }\n    }\n\n    // 获取常用的 attribute\n    const attributeNames = ['aPosition', 'aTexCoord'];\n\n    for (const name of attributeNames) {\n      const location = this.gl.getAttribLocation(program, name);\n      if (location !== -1) {\n        attributes.set(name, location);\n      }\n    }\n\n    const shaderProgram: ShaderProgram = {\n      id: program,\n      vertexShader,\n      fragmentShader,\n      uniforms,\n      attributes,\n    };\n\n    this.programs.set(name, shaderProgram);\n\n    console.log(`Shader '${name}' compiled successfully in ${compilationTime.toFixed(2)}ms`);\n\n    return shaderProgram;\n  }\n\n  /**\n   * 获取着色器程序\n   */\n  getProgram(name: string): ShaderProgram | null {\n    return this.programs.get(name) || null;\n  }\n\n  /**\n   * 使用着色器程序\n   */\n  useProgram(name: string): boolean {\n    const program = this.programs.get(name);\n    if (!program) return false;\n\n    this.gl.useProgram(program.id);\n    return true;\n  }\n\n  /**\n   * 设置 uniform 浮点数\n   */\n  setUniform1f(programName: string, uniformName: string, value: number): boolean {\n    const program = this.programs.get(programName);\n    if (!program) return false;\n\n    const location = program.uniforms.get(uniformName);\n    if (!location) return false;\n\n    this.gl.uniform1f(location, value);\n    return true;\n  }\n\n  /**\n   * 设置 uniform 二维向量\n   */\n  setUniform2f(programName: string, uniformName: string, x: number, y: number): boolean {\n    const program = this.programs.get(programName);\n    if (!program) return false;\n\n    const location = program.uniforms.get(uniformName);\n    if (!location) return false;\n\n    this.gl.uniform2f(location, x, y);\n    return true;\n  }\n\n  /**\n   * 设置 uniform 纹理\n   */\n  setUniformTexture(\n    programName: string,\n    uniformName: string,\n    texture: WebGLTexture,\n    unit: number = 0\n  ): boolean {\n    const program = this.programs.get(programName);\n    if (!program) return false;\n\n    const location = program.uniforms.get(uniformName);\n    if (!location) return false;\n\n    this.gl.activeTexture(this.gl.TEXTURE0 + unit);\n    this.gl.bindTexture(this.gl.TEXTURE_2D, texture);\n    this.gl.uniform1i(location, unit);\n\n    return true;\n  }\n\n  /**\n   * 应用美颜参数\n   */\n  applyBeautyParams(programName: string, params: BeautyShaderParams): boolean {\n    if (!this.useProgram(programName)) return false;\n\n    // 设置美颜参数\n    this.setUniform1f(programName, 'uSmoothingStrength', params.smoothing);\n    this.setUniform1f(programName, 'uBlurRadius', params.blurRadius);\n    this.setUniform1f(programName, 'uSaturation', params.saturation);\n    this.setUniform1f(programName, 'uBrightness', params.brightness);\n    this.setUniform1f(programName, 'uWarmth', params.warmth);\n    this.setUniform1f(programName, 'uEyeBrightness', params.eyeBrightness);\n    this.setUniform1f(programName, 'uEyeContrast', params.eyeContrast);\n    this.setUniform1f(programName, 'uThinningStrength', params.faceThinning);\n\n    return true;\n  }\n\n  /**\n   * 获取性能指标\n   */\n  getPerformance(): ShaderPerformance {\n    this.frameCount++;\n    const currentTime = Date.now();\n    const elapsed = currentTime - this.lastTime;\n\n    if (elapsed >= 1000) {\n      this.performance.fps = (this.frameCount * 1000) / elapsed;\n      this.frameCount = 0;\n      this.lastTime = currentTime;\n    }\n\n    return this.performance;\n  }\n\n  /**\n   * 删除着色器程序\n   */\n  deleteProgram(name: string): boolean {\n    const program = this.programs.get(name);\n    if (!program) return false;\n\n    this.gl.deleteShader(program.vertexShader);\n    this.gl.deleteShader(program.fragmentShader);\n    this.gl.deleteProgram(program.id);\n\n    this.programs.delete(name);\n    return true;\n  }\n\n  /**\n   * 删除所有着色器程序\n   */\n  deleteAllPrograms(): void {\n    for (const [name] of this.programs) {\n      this.deleteProgram(name);\n    }\n    this.programs.clear();\n  }\n}\n\nexport default ShaderManager;\n
