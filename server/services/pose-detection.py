\"\"\"第四阶段：AR 姿势引导 - MediaPipe Pose 检测服务\n\n功能：\n- MediaPipe Pose 实时骨架检测\n- 33 个关键点检测\n- 姿势相似度计算\n- 姿势模板管理\n- 实时匹配反馈\n\n性能目标：\n- 帧率：30fps+\n- 延迟：< 100ms\n- 内存：< 200MB\n- 精度：> 85%\n\n作者：Manus AI\n日期：2025-01-13\n\"\"\"\n\nimport asyncio\nimport json\nimport os\nfrom typing import List, Dict, Tuple, Optional\nfrom dataclasses import dataclass, asdict\nfrom enum import Enum\nimport numpy as np\nimport cv2\nfrom mediapipe.python.solutions import pose as mp_pose\nfrom mediapipe.python.solutions import drawing_utils as mp_drawing\nimport time\n\n# ============ 类型定义 ============\n\nclass PoseStyle(str, Enum):\n    \"\"\"姿势风格\"\"\"\n    CORSAGE = \"corsage\"        # 可颂风格\n    KULOMI = \"kulomi\"          # 库洛米风格\n    NATURAL = \"natural\"        # 自然风格\n\n@dataclass\nclass KeyPoint:\n    \"\"\"关键点\"\"\"\n    x: float\n    y: float\n    z: float\n    visibility: float\n\n@dataclass\nclass Pose:\n    \"\"\"姿势\"\"\"\n    pose_id: str\n    pose_name: str\n    style: PoseStyle\n    description: str\n    keypoints: List[KeyPoint]\n    thumbnail_url: Optional[str] = None\n    difficulty: int = 1  # 1-5 难度等级\n\n@dataclass\nclass PoseDetectionResult:\n    \"\"\"姿势检测结果\"\"\"\n    timestamp: float\n    keypoints: List[KeyPoint]\n    confidence: float\n    pose_matches: List[Tuple[str, float]]  # (pose_id, similarity)\n    best_match: Optional[Tuple[str, float]] = None\n\n# ============ 常量 ============\n\nMIN_DETECTION_CONFIDENCE = 0.5\nMIN_TRACKING_CONFIDENCE = 0.5\nSIMILARITY_THRESHOLD = 0.85\n\n# 33 个 MediaPipe 关键点索引\nKEYPOINT_NAMES = [\n    \"nose\", \"left_eye_inner\", \"left_eye\", \"left_eye_outer\",\n    \"right_eye_inner\", \"right_eye\", \"right_eye_outer\",\n    \"left_ear\", \"right_ear\",\n    \"mouth_left\", \"mouth_right\",\n    \"left_shoulder\", \"right_shoulder\",\n    \"left_elbow\", \"right_elbow\",\n    \"left_wrist\", \"right_wrist\",\n    \"left_pinky\", \"right_pinky\",\n    \"left_index\", \"right_index\",\n    \"left_thumb\", \"right_thumb\",\n    \"left_hip\", \"right_hip\",\n    \"left_knee\", \"right_knee\",\n    \"left_ankle\", \"right_ankle\",\n    \"left_heel\", \"right_heel\",\n    \"left_foot_index\", \"right_foot_index\",\n]\n\n# ============ 姿势模板库 ============\n\nPOSE_TEMPLATES = {\n    # 可颂风格姿势\n    \"corsage_standing_front\": {\n        \"name\": \"站立正面\",\n        \"style\": PoseStyle.CORSAGE,\n        \"description\": \"双脚并立，双手自然下垂，面向相机\",\n        \"difficulty\": 1,\n    },\n    \"corsage_standing_side\": {\n        \"name\": \"站立侧面\",\n        \"style\": PoseStyle.CORSAGE,\n        \"description\": \"侧身站立，展示身体线条\",\n        \"difficulty\": 2,\n    },\n    \"corsage_hand_on_hip\": {\n        \"name\": \"手放腰部\",\n        \"style\": PoseStyle.CORSAGE,\n        \"description\": \"一手放在腰部，另一手自然下垂\",\n        \"difficulty\": 2,\n    },\n    \"corsage_hands_up\": {\n        \"name\": \"双手向上\",\n        \"style\": PoseStyle.CORSAGE,\n        \"description\": \"双手向上举起，展现活力\",\n        \"difficulty\": 2,\n    },\n    \"corsage_hands_behind_head\": {\n        \"name\": \"双手抱头\",\n        \"style\": PoseStyle.CORSAGE,\n        \"description\": \"双手放在头后，展现优雅\",\n        \"difficulty\": 2,\n    },\n    \"corsage_sitting\": {\n        \"name\": \"坐姿正面\",\n        \"style\": PoseStyle.CORSAGE,\n        \"description\": \"坐姿面向相机，展现气质\",\n        \"difficulty\": 3,\n    },\n    \"corsage_sitting_side\": {\n        \"name\": \"坐姿侧面\",\n        \"style\": PoseStyle.CORSAGE,\n        \"description\": \"坐姿侧身，展示身体曲线\",\n        \"difficulty\": 3,\n    },\n    \"corsage_lying_down\": {\n        \"name\": \"躺卧姿势\",\n        \"style\": PoseStyle.CORSAGE,\n        \"description\": \"躺卧拍摄，营造慵懒感\",\n        \"difficulty\": 3,\n    },\n    \"corsage_jumping\": {\n        \"name\": \"跳跃姿势\",\n        \"style\": PoseStyle.CORSAGE,\n        \"description\": \"跳起来拍摄，展现活力\",\n        \"difficulty\": 4,\n    },\n    \"corsage_dancing\": {\n        \"name\": \"舞蹈姿势\",\n        \"style\": PoseStyle.CORSAGE,\n        \"description\": \"舞蹈动作，展现灵动\",\n        \"difficulty\": 4,\n    },\n    \n    # 库洛米风格姿势\n    \"kulomi_cute_pose\": {\n        \"name\": \"可爱姿势\",\n        \"style\": PoseStyle.KULOMI,\n        \"description\": \"双手放在脸颊，做出可爱表情\",\n        \"difficulty\": 2,\n    },\n    \"kulomi_v_pose\": {\n        \"name\": \"V 字手势\",\n        \"style\": PoseStyle.KULOMI,\n        \"description\": \"双手做出 V 字手势\",\n        \"difficulty\": 1,\n    },\n    \"kulomi_heart_pose\": {\n        \"name\": \"心形手势\",\n        \"style\": PoseStyle.KULOMI,\n        \"description\": \"双手做出心形手势\",\n        \"difficulty\": 2,\n    },\n    \"kulomi_peace_pose\": {\n        \"name\": \"和平手势\",\n        \"style\": PoseStyle.KULOMI,\n        \"description\": \"双手做出和平手势\",\n        \"difficulty\": 1,\n    },\n    \"kulomi_angel_pose\": {\n        \"name\": \"天使姿势\",\n        \"style\": PoseStyle.KULOMI,\n        \"description\": \"双手放在头顶，做出天使光环\",\n        \"difficulty\": 2,\n    },\n    \"kulomi_devil_pose\": {\n        \"name\": \"恶魔姿势\",\n        \"style\": PoseStyle.KULOMI,\n        \"description\": \"双手放在头顶，做出恶魔角\",\n        \"difficulty\": 2,\n    },\n    \"kulomi_thinking_pose\": {\n        \"name\": \"思考姿势\",\n        \"style\": PoseStyle.KULOMI,\n        \"description\": \"手放在下巴，做出思考状\",\n        \"difficulty\": 2,\n    },\n    \"kulomi_shy_pose\": {\n        \"name\": \"害羞姿势\",\n        \"style\": PoseStyle.KULOMI,\n        \"description\": \"双手遮住脸，做出害羞状\",\n        \"difficulty\": 2,\n    },\n    \"kulomi_excited_pose\": {\n        \"name\": \"兴奋姿势\",\n        \"style\": PoseStyle.KULOMI,\n        \"description\": \"双手举起，做出兴奋状\",\n        \"difficulty\": 2,\n    },\n    \"kulomi_cool_pose\": {\n        \"name\": \"酷炫姿势\",\n        \"style\": PoseStyle.KULOMI,\n        \"description\": \"单手放在头上，做出酷炫状\",\n        \"difficulty\": 2,\n    },\n}\n\n# ============ 姿势检测器 ============\n\nclass PoseDetector:\n    \"\"\"姿势检测器\"\"\"\n    \n    def __init__(self):\n        \"\"\"初始化姿势检测器\"\"\"\n        self.pose = mp_pose.Pose(\n            static_image_mode=False,\n            model_complexity=1,\n            smooth_landmarks=True,\n            min_detection_confidence=MIN_DETECTION_CONFIDENCE,\n            min_tracking_confidence=MIN_TRACKING_CONFIDENCE,\n        )\n        self.pose_templates: Dict[str, Pose] = {}\n        self._init_pose_templates()\n    \n    def _init_pose_templates(self):\n        \"\"\"初始化姿势模板\"\"\"\n        for pose_id, template_info in POSE_TEMPLATES.items():\n            # TODO: 从数据库或文件加载真实的关键点数据\n            # 这里使用占位符实现\n            self.pose_templates[pose_id] = Pose(\n                pose_id=pose_id,\n                pose_name=template_info[\"name\"],\n                style=template_info[\"style\"],\n                description=template_info[\"description\"],\n                keypoints=[KeyPoint(0, 0, 0, 1) for _ in range(33)],\n                difficulty=template_info[\"difficulty\"],\n            )\n    \n    def detect_pose(self, image: np.ndarray) -> Optional[PoseDetectionResult]:\n        \"\"\"检测图片中的姿势\"\"\"\n        try:\n            # 转换为 RGB\n            image_rgb = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)\n            \n            # 运行姿势检测\n            results = self.pose.process(image_rgb)\n            \n            if not results.pose_landmarks:\n                return None\n            \n            # 提取关键点\n            keypoints = []\n            for landmark in results.pose_landmarks.landmark:\n                keypoints.append(KeyPoint(\n                    x=landmark.x,\n                    y=landmark.y,\n                    z=landmark.z,\n                    visibility=landmark.visibility,\n                ))\n            \n            # 计算置信度（平均可见度）\n            confidence = np.mean([kp.visibility for kp in keypoints])\n            \n            # 与所有模板计算相似度\n            pose_matches = []\n            for pose_id, template in self.pose_templates.items():\n                similarity = self._calculate_similarity(keypoints, template.keypoints)\n                pose_matches.append((pose_id, similarity))\n            \n            # 排序并获取最佳匹配\n            pose_matches.sort(key=lambda x: x[1], reverse=True)\n            best_match = pose_matches[0] if pose_matches[0][1] > SIMILARITY_THRESHOLD else None\n            \n            return PoseDetectionResult(\n                timestamp=time.time(),\n                keypoints=keypoints,\n                confidence=float(confidence),\n                pose_matches=pose_matches[:5],  # 返回前 5 个匹配\n                best_match=best_match,\n            )\n            \n        except Exception as e:\n            print(f\"❌ 姿势检测失败: {e}\")\n            return None\n    \n    def _calculate_similarity(self, keypoints1: List[KeyPoint], keypoints2: List[KeyPoint]) -> float:\n        \"\"\"计算两个姿势的相似度（余弦相似度）\"\"\"\n        try:\n            # 转换为向量\n            vec1 = np.array([(kp.x, kp.y, kp.z) for kp in keypoints1]).flatten()\n            vec2 = np.array([(kp.x, kp.y, kp.z) for kp in keypoints2]).flatten()\n            \n            # 归一化\n            vec1 = vec1 / (np.linalg.norm(vec1) + 1e-8)\n            vec2 = vec2 / (np.linalg.norm(vec2) + 1e-8)\n            \n            # 计算余弦相似度\n            similarity = float(np.dot(vec1, vec2))\n            \n            # 映射到 0-1 范围\n            similarity = (similarity + 1) / 2\n            \n            return max(0, min(1, similarity))\n            \n        except Exception as e:\n            print(f\"❌ 相似度计算失败: {e}\")\n            return 0.0\n    \n    def draw_pose(self, image: np.ndarray, keypoints: List[KeyPoint]) -> np.ndarray:\n        \"\"\"在图片上绘制骨架\"\"\"\n        try:\n            h, w, c = image.shape\n            \n            # 绘制关键点\n            for i, kp in enumerate(keypoints):\n                if kp.visibility > 0.5:\n                    x = int(kp.x * w)\n                    y = int(kp.y * h)\n                    cv2.circle(image, (x, y), 5, (0, 255, 0), -1)\n                    cv2.putText(image, str(i), (x + 5, y), cv2.FONT_HERSHEY_SIMPLEX, 0.3, (0, 255, 0))\n            \n            # 绘制连接线\n            connections = [\n                (0, 1), (1, 2), (2, 3),  # 头部\n                (5, 6), (6, 7),  # 右眼\n                (8, 9), (9, 10),  # 左眼\n                (11, 12),  # 肩膀\n                (11, 13), (13, 15),  # 左臂\n                (12, 14), (14, 16),  # 右臂\n                (11, 23), (12, 24),  # 躯干\n                (23, 25), (25, 27),  # 左腿\n                (24, 26), (26, 28),  # 右腿\n            ]\n            \n            for start, end in connections:\n                if keypoints[start].visibility > 0.5 and keypoints[end].visibility > 0.5:\n                    x1 = int(keypoints[start].x * w)\n                    y1 = int(keypoints[start].y * h)\n                    x2 = int(keypoints[end].x * w)\n                    y2 = int(keypoints[end].y * h)\n                    cv2.line(image, (x1, y1), (x2, y2), (0, 255, 0), 2)\n            \n            return image\n            \n        except Exception as e:\n            print(f\"❌ 绘制骨架失败: {e}\")\n            return image\n    \n    def get_pose_templates(self, style: Optional[PoseStyle] = None) -> List[Pose]:\n        \"\"\"获取姿势模板\"\"\"\n        templates = list(self.pose_templates.values())\n        if style:\n            templates = [t for t in templates if t.style == style]\n        return templates\n    \n    def release(self):\n        \"\"\"释放资源\"\"\"\n        self.pose.close()\n\n# ============ 全局实例 ============\n\n_pose_detector: Optional[PoseDetector] = None\n\ndef get_pose_detector() -> PoseDetector:\n    \"\"\"获取全局姿势检测器实例\"\"\"\n    global _pose_detector\n    if _pose_detector is None:\n        _pose_detector = PoseDetector()\n    return _pose_detector\n\n# ============ 测试 ============\n\nif __name__ == \"__main__\":\n    import sys\n    \n    detector = get_pose_detector()\n    \n    # 测试模板\n    templates = detector.get_pose_templates()\n    print(f\"✅ 加载了 {len(templates)} 个姿势模板\")\n    \n    for template in templates:\n        print(f\"  - {template.pose_name} ({template.style.value})\")\n    \n    # 测试相机\n    cap = cv2.VideoCapture(0)\n    \n    while True:\n        ret, frame = cap.read()\n        if not ret:\n            break\n        \n        # 检测姿势\n        result = detector.detect_pose(frame)\n        \n        if result:\n            # 绘制骨架\n            frame = detector.draw_pose(frame, result.keypoints)\n            \n            # 显示最佳匹配\n            if result.best_match:\n                pose_id, similarity = result.best_match\n                template = detector.pose_templates[pose_id]\n                cv2.putText(frame, f\"Best Match: {template.pose_name} ({similarity:.2f})\", (10, 30), cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 255, 0), 2)\n                \n                # 如果相似度 > 85%，显示快门按钮变色\n                if similarity > SIMILARITY_THRESHOLD:\n                    cv2.circle(frame, (frame.shape[1] // 2, frame.shape[0] - 50), 50, (0, 255, 0), -1)\n                    cv2.putText(frame, \"READY!\", (frame.shape[1] // 2 - 40, frame.shape[0] - 30), cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 255, 255), 2)\n        \n        # 显示帧\n        cv2.imshow(\"Pose Detection\", frame)\n        \n        if cv2.waitKey(1) & 0xFF == ord('q'):\n            break\n    \n    cap.release()\n    cv2.destroyAllWindows()\n    detector.release()\n
