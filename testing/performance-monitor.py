#!/usr/bin/env python3\n\"\"\"\nyanbao AI 性能监测工具\n\n用于在 Android 设备上实时监测性能指标：\n- CPU 使用率\n- 内存占用\n- GPU 使用率\n- 帧率（FPS）\n- 温度\n- 电池消耗\n\"\"\"\n\nimport subprocess\nimport re\nimport time\nimport json\nfrom datetime import datetime\nfrom typing import Dict, List, Optional\nimport statistics\n\n\nclass AndroidPerformanceMonitor:\n    \"\"\"Android 性能监测工具\"\"\"\n\n    def __init__(self, package_name: str = \"com.yanbao.ai\"):\n        self.package_name = package_name\n        self.metrics = []\n        self.start_time = None\n\n    def get_device_info(self) -> Dict:\n        \"\"\"获取设备信息\"\"\"\n        try:\n            # 获取设备型号\n            model = subprocess.check_output(\n                \"adb shell getprop ro.product.model\",\n                shell=True,\n                text=True\n            ).strip()\n\n            # 获取 Android 版本\n            android_version = subprocess.check_output(\n                \"adb shell getprop ro.build.version.release\",\n                shell=True,\n                text=True\n            ).strip()\n\n            # 获取 RAM 大小\n            ram_info = subprocess.check_output(\n                \"adb shell cat /proc/meminfo | grep MemTotal\",\n                shell=True,\n                text=True\n            ).strip()\n            ram_kb = int(re.search(r'\\d+', ram_info).group())\n            ram_gb = ram_kb / 1024 / 1024\n\n            return {\n                \"model\": model,\n                \"android_version\": android_version,\n                \"ram_gb\": round(ram_gb, 2),\n                \"timestamp\": datetime.now().isoformat()\n            }\n        except Exception as e:\n            print(f\"获取设备信息失败: {e}\")\n            return {}\n\n    def get_cpu_usage(self) -> float:\n        \"\"\"获取 CPU 使用率（%）\"\"\"\n        try:\n            output = subprocess.check_output(\n                f\"adb shell top -n 1 | grep {self.package_name}\",\n                shell=True,\n                text=True\n            ).strip()\n\n            # 解析 CPU 使用率\n            parts = output.split()\n            cpu_usage = float(parts[-2].rstrip('%'))\n            return cpu_usage\n        except Exception as e:\n            print(f\"获取 CPU 使用率失败: {e}\")\n            return 0.0\n\n    def get_memory_usage(self) -> Dict:\n        \"\"\"获取内存占用（MB）\"\"\"\n        try:\n            output = subprocess.check_output(\n                f\"adb shell dumpsys meminfo {self.package_name}\",\n                shell=True,\n                text=True\n            ).strip()\n\n            # 解析 PSS 内存\n            pss_match = re.search(r'TOTAL\\s+(\\d+)', output)\n            if pss_match:\n                total_pss_kb = int(pss_match.group(1))\n                total_pss_mb = total_pss_kb / 1024\n\n                # 解析堆内存\n                heap_match = re.search(r'Heap Size\\s+(\\d+)', output)\n                heap_size_kb = int(heap_match.group(1)) if heap_match else 0\n                heap_size_mb = heap_size_kb / 1024\n\n                return {\n                    \"total_pss_mb\": round(total_pss_mb, 2),\n                    \"heap_size_mb\": round(heap_size_mb, 2),\n                    \"native_heap_mb\": round((total_pss_mb - heap_size_mb), 2)\n                }\n        except Exception as e:\n            print(f\"获取内存占用失败: {e}\")\n        return {\"total_pss_mb\": 0, \"heap_size_mb\": 0, \"native_heap_mb\": 0}\n\n    def get_fps(self) -> float:\n        \"\"\"获取帧率（FPS）\"\"\"\n        try:\n            output = subprocess.check_output(\n                f\"adb shell dumpsys gfxinfo {self.package_name} | grep 'Frame time'\",\n                shell=True,\n                text=True\n            ).strip()\n\n            # 简单估算 FPS（基于帧时间）\n            if output:\n                # 获取最后一行的帧时间\n                lines = output.split('\\n')\n                last_line = lines[-1]\n                frame_time_ms = float(last_line.split()[-1])\n                fps = 1000 / frame_time_ms if frame_time_ms > 0 else 0\n                return round(fps, 1)\n        except Exception as e:\n            print(f\"获取帧率失败: {e}\")\n        return 0.0\n\n    def get_temperature(self) -> float:\n        \"\"\"获取设备温度（°C）\"\"\"\n        try:\n            output = subprocess.check_output(\n                \"adb shell cat /sys/class/thermal/thermal_zone0/temp\",\n                shell=True,\n                text=True\n            ).strip()\n            temp_celsius = int(output) / 1000\n            return round(temp_celsius, 1)\n        except Exception as e:\n            print(f\"获取温度失败: {e}\")\n            return 0.0\n\n    def get_battery_info(self) -> Dict:\n        \"\"\"获取电池信息\"\"\"\n        try:\n            output = subprocess.check_output(\n                \"adb shell dumpsys battery\",\n                shell=True,\n                text=True\n            ).strip()\n\n            level_match = re.search(r'level: (\\d+)', output)\n            temp_match = re.search(r'temperature: (\\d+)', output)\n            status_match = re.search(r'status: (\\w+)', output)\n\n            return {\n                \"level\": int(level_match.group(1)) if level_match else 0,\n                \"temperature\": int(temp_match.group(1)) if temp_match else 0,\n                \"status\": status_match.group(1) if status_match else \"Unknown\"\n            }\n        except Exception as e:\n            print(f\"获取电池信息失败: {e}\")\n            return {\"level\": 0, \"temperature\": 0, \"status\": \"Unknown\"}\n\n    def collect_metrics(self, duration_seconds: int = 60, interval: int = 2) -> List[Dict]:\n        \"\"\"收集性能指标\n\n        Args:\n            duration_seconds: 收集时长（秒）\n            interval: 收集间隔（秒）\n\n        Returns:\n            性能指标列表\n        \"\"\"\n        self.start_time = time.time()\n        self.metrics = []\n\n        print(f\"开始收集性能指标（{duration_seconds}秒）...\")\n        print(f\"设备信息: {self.get_device_info()}\")\n        print()\n\n        elapsed = 0\n        while elapsed < duration_seconds:\n            metric = {\n                \"timestamp\": datetime.now().isoformat(),\n                \"elapsed_seconds\": elapsed,\n                \"cpu_usage\": self.get_cpu_usage(),\n                \"memory\": self.get_memory_usage(),\n                \"fps\": self.get_fps(),\n                \"temperature\": self.get_temperature(),\n                \"battery\": self.get_battery_info()\n            }\n            self.metrics.append(metric)\n\n            # 打印实时数据\n            print(f\"[{elapsed}s] CPU: {metric['cpu_usage']:.1f}% | \"\n                  f\"内存: {metric['memory']['total_pss_mb']:.0f}MB | \"\n                  f\"FPS: {metric['fps']:.1f} | \"\n                  f\"温度: {metric['temperature']:.1f}°C | \"\n                  f\"电池: {metric['battery']['level']}%\")\n\n            time.sleep(interval)\n            elapsed += interval\n\n        return self.metrics\n\n    def generate_report(self, output_file: str = \"performance_report.json\") -> Dict:\n        \"\"\"生成性能报告\n\n        Args:\n            output_file: 输出文件名\n\n        Returns:\n            性能报告\n        \"\"\"\n        if not self.metrics:\n            print(\"没有收集到性能指标\")\n            return {}\n\n        # 提取所有指标\n        cpu_values = [m[\"cpu_usage\"] for m in self.metrics]\n        memory_values = [m[\"memory\"][\"total_pss_mb\"] for m in self.metrics]\n        fps_values = [m[\"fps\"] for m in self.metrics if m[\"fps\"] > 0]\n        temp_values = [m[\"temperature\"] for m in self.metrics if m[\"temperature\"] > 0]\n\n        # 计算统计数据\n        report = {\n            \"device_info\": self.get_device_info(),\n            \"test_duration_seconds\": len(self.metrics) * 2,  # 假设间隔为 2 秒\n            \"cpu\": {\n                \"average\": round(statistics.mean(cpu_values), 2) if cpu_values else 0,\n                \"max\": round(max(cpu_values), 2) if cpu_values else 0,\n                \"min\": round(min(cpu_values), 2) if cpu_values else 0,\n                \"stdev\": round(statistics.stdev(cpu_values), 2) if len(cpu_values) > 1 else 0\n            },\n            \"memory\": {\n                \"average_mb\": round(statistics.mean(memory_values), 2) if memory_values else 0,\n                \"max_mb\": round(max(memory_values), 2) if memory_values else 0,\n                \"min_mb\": round(min(memory_values), 2) if memory_values else 0,\n                \"stdev_mb\": round(statistics.stdev(memory_values), 2) if len(memory_values) > 1 else 0\n            },\n            \"fps\": {\n                \"average\": round(statistics.mean(fps_values), 1) if fps_values else 0,\n                \"max\": round(max(fps_values), 1) if fps_values else 0,\n                \"min\": round(min(fps_values), 1) if fps_values else 0,\n                \"stdev\": round(statistics.stdev(fps_values), 1) if len(fps_values) > 1 else 0\n            },\n            \"temperature\": {\n                \"average\": round(statistics.mean(temp_values), 1) if temp_values else 0,\n                \"max\": round(max(temp_values), 1) if temp_values else 0,\n                \"min\": round(min(temp_values), 1) if temp_values else 0\n            },\n            \"metrics\": self.metrics\n        }\n\n        # 保存报告\n        with open(output_file, 'w') as f:\n            json.dump(report, f, indent=2)\n\n        print(f\"\\n性能报告已保存到: {output_file}\")\n        return report\n\n    def print_summary(self, report: Dict):\n        \"\"\"打印性能摘要\"\"\"\n        print(\"\\n\" + \"=\"*60)\n        print(\"性能测试摘要\")\n        print(\"=\"*60)\n        print(f\"设备: {report['device_info']['model']}\")\n        print(f\"Android 版本: {report['device_info']['android_version']}\")\n        print(f\"RAM: {report['device_info']['ram_gb']}GB\")\n        print(f\"测试时长: {report['test_duration_seconds']}秒\")\n        print()\n        print(\"CPU 使用率:\")\n        print(f\"  平均: {report['cpu']['average']:.1f}%\")\n        print(f\"  最大: {report['cpu']['max']:.1f}%\")\n        print(f\"  最小: {report['cpu']['min']:.1f}%\")\n        print()\n        print(\"内存占用:\")\n        print(f\"  平均: {report['memory']['average_mb']:.0f}MB\")\n        print(f\"  最大: {report['memory']['max_mb']:.0f}MB\")\n        print(f\"  最小: {report['memory']['min_mb']:.0f}MB\")\n        print()\n        print(\"帧率 (FPS):\")\n        print(f\"  平均: {report['fps']['average']:.1f}fps\")\n        print(f\"  最大: {report['fps']['max']:.1f}fps\")\n        print(f\"  最小: {report['fps']['min']:.1f}fps\")\n        print()\n        print(\"温度:\")\n        print(f\"  平均: {report['temperature']['average']:.1f}°C\")\n        print(f\"  最大: {report['temperature']['max']:.1f}°C\")\n        print(f\"  最小: {report['temperature']['min']:.1f}°C\")\n        print(\"=\"*60)\n\n\nif __name__ == \"__main__\":\n    import argparse\n\n    parser = argparse.ArgumentParser(description=\"yanbao AI 性能监测工具\")\n    parser.add_argument(\n        \"--duration\",\n        type=int,\n        default=60,\n        help=\"监测时长（秒），默认 60\"\n    )\n    parser.add_argument(\n        \"--interval\",\n        type=int,\n        default=2,\n        help=\"采样间隔（秒），默认 2\"\n    )\n    parser.add_argument(\n        \"--package\",\n        type=str,\n        default=\"com.yanbao.ai\",\n        help=\"应用包名，默认 com.yanbao.ai\"\n    )\n    parser.add_argument(\n        \"--output\",\n        type=str,\n        default=\"performance_report.json\",\n        help=\"输出文件名，默认 performance_report.json\"\n    )\n\n    args = parser.parse_args()\n\n    # 创建监测工具\n    monitor = AndroidPerformanceMonitor(package_name=args.package)\n\n    # 收集指标\n    metrics = monitor.collect_metrics(\n        duration_seconds=args.duration,\n        interval=args.interval\n    )\n\n    # 生成报告\n    report = monitor.generate_report(output_file=args.output)\n\n    # 打印摘要\n    monitor.print_summary(report)\n
