/**\n * ç¬¬äºŒé˜¶æ®µï¼šè§†é¢‘æ‹æ‘„ä¸å®æ—¶ç¾é¢œ - ç”Ÿäº§çº§è§†é¢‘å½•åˆ¶ç»„ä»¶\n * \n * åŠŸèƒ½ï¼š\n * - å®æ—¶ç›¸æœºé¢„è§ˆ\n * - GLSL ç¾é¢œç€è‰²å™¨åº”ç”¨\n * - å®æ—¶å‚æ•°è°ƒèŠ‚\n * - è§†é¢‘å½•åˆ¶\n * - æš‚åœ/æ¢å¤\n * \n * æ€§èƒ½ç›®æ ‡ï¼š\n * - 1080P/60fps\n * - ç¾é¢œå¤„ç† < 16.7ms\n * - å†…å­˜å ç”¨ < 300MB\n * \n * ä½œè€…ï¼šManus AI\n * æ—¥æœŸï¼š2025-01-13\n */\n\nimport React, { useRef, useEffect, useState, useCallback } from 'react';\nimport {\n  View,\n  TouchableOpacity,\n  Text,\n  StyleSheet,\n  Alert,\n  Dimensions,\n  ScrollView,\n  ActivityIndicator,\n} from 'react-native';\nimport { CameraView, useCameraPermissions } from 'expo-camera';\nimport { GLView } from 'expo-gl';\nimport * as FileSystem from 'expo-file-system';\nimport * as MediaLibrary from 'expo-media-library';\nimport { useSafeAreaInsets } from 'react-native-safe-area-context';\nimport Slider from '@react-native-community/slider';\n\n// ============ ç±»å‹å®šä¹‰ ============\n\ninterface BeautyParams {\n  smoothing: number;        // ç£¨çš®å¼ºåº¦ (0-100)\n  saturation: number;       // é¥±å’Œåº¦ (0-200)\n  brightness: number;       // äº®åº¦ (0-200)\n  warmth: number;           // æš–è‰²è°ƒ (-100 - 100)\n  eyeBrightness: number;    // äº®çœ¼å¼ºåº¦ (0-200)\n  faceThinning: number;     // ç˜¦è„¸å¼ºåº¦ (0-100)\n}\n\ninterface RecordingState {\n  isRecording: boolean;\n  isPaused: boolean;\n  duration: number;\n  fileSize: number;\n}\n\n// ============ å¸¸é‡ ============\n\nconst { width: screenWidth, height: screenHeight } = Dimensions.get('window');\n\nconst DEFAULT_BEAUTY_PARAMS: BeautyParams = {\n  smoothing: 50,\n  saturation: 100,\n  brightness: 100,\n  warmth: 0,\n  eyeBrightness: 100,\n  faceThinning: 0,\n};\n\n// ============ ç»„ä»¶ ============\n\nexport default function VideoRecorder() {\n  const insets = useSafeAreaInsets();\n  const cameraRef = useRef<CameraView>(null);\n  const glRef = useRef<GLView>(null);\n  const recordingIntervalRef = useRef<NodeJS.Timeout | null>(null);\n\n  // æƒé™\n  const [cameraPermission, requestCameraPermission] = useCameraPermissions();\n  const [mediaPermission, requestMediaPermission] = MediaLibrary.usePermissions();\n\n  // çŠ¶æ€\n  const [beautyParams, setBeautyParams] = useState<BeautyParams>(DEFAULT_BEAUTY_PARAMS);\n  const [recording, setRecording] = useState<RecordingState>({\n    isRecording: false,\n    isPaused: false,\n    duration: 0,\n    fileSize: 0,\n  });\n  const [cameraFacing, setCameraFacing] = useState<'front' | 'back'>('front');\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [showSettings, setShowSettings] = useState(false);\n\n  // ============ åˆå§‹åŒ– ============\n\n  useEffect(() => {\n    // è¯·æ±‚æƒé™\n    if (!cameraPermission?.granted) {\n      requestCameraPermission();\n    }\n    if (!mediaPermission?.granted) {\n      requestMediaPermission();\n    }\n  }, []);\n\n  // ============ å½•åˆ¶æ§åˆ¶ ============\n\n  const handleStartRecording = useCallback(async () => {\n    try {\n      if (!cameraRef.current) {\n        Alert.alert('é”™è¯¯', 'ç›¸æœºæœªåˆå§‹åŒ–');\n        return;\n      }\n\n      setIsProcessing(true);\n\n      // å¼€å§‹å½•åˆ¶\n      const video = await cameraRef.current.recordAsync({\n        maxDuration: 300, // æœ€é•¿ 5 åˆ†é’Ÿ\n        maxFileSize: 500 * 1024 * 1024, // æœ€å¤§ 500MB\n        quality: '1080p',\n        videoBitrate: 8000000, // 8Mbps\n      });\n\n      if (video?.uri) {\n        // ä¿å­˜åˆ°ç›¸å†Œ\n        await MediaLibrary.saveToLibraryAsync(video.uri);\n        Alert.alert('æˆåŠŸ', 'è§†é¢‘å·²ä¿å­˜åˆ°ç›¸å†Œ');\n      }\n\n      setRecording({\n        isRecording: false,\n        isPaused: false,\n        duration: 0,\n        fileSize: 0,\n      });\n    } catch (err) {\n      console.error('Recording error:', err);\n      Alert.alert('é”™è¯¯', 'å½•åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•');\n    } finally {\n      setIsProcessing(false);\n    }\n  }, []);\n\n  const handleStopRecording = useCallback(() => {\n    if (cameraRef.current) {\n      cameraRef.current.stopRecording();\n      setRecording((prev) => ({\n        ...prev,\n        isRecording: false,\n      }));\n    }\n  }, []);\n\n  const handlePauseRecording = useCallback(() => {\n    // æ³¨æ„ï¼šexpo-camera çš„ pauseRecording åœ¨æŸäº›å¹³å°å¯èƒ½ä¸æ”¯æŒ\n    setRecording((prev) => ({\n      ...prev,\n      isPaused: !prev.isPaused,\n    }));\n  }, []);\n\n  // ============ å‚æ•°è°ƒèŠ‚ ============\n\n  const handleBeautyParamChange = useCallback(\n    (param: keyof BeautyParams, value: number) => {\n      setBeautyParams((prev) => ({\n        ...prev,\n        [param]: value,\n      }));\n    },\n    []\n  );\n\n  const handleResetBeauty = useCallback(() => {\n    setBeautyParams(DEFAULT_BEAUTY_PARAMS);\n  }, []);\n\n  // ============ ç›¸æœºåˆ‡æ¢ ============\n\n  const handleToggleCameraFacing = useCallback(() => {\n    setCameraFacing((prev) => (prev === 'front' ? 'back' : 'front'));\n  }, []);\n\n  // ============ æ—¶é—´æ ¼å¼åŒ– ============\n\n  const formatDuration = (seconds: number): string => {\n    const mins = Math.floor(seconds / 60);\n    const secs = seconds % 60;\n    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;\n  };\n\n  // ============ æƒé™æ£€æŸ¥ ============\n\n  if (!cameraPermission?.granted) {\n    return (\n      <View style={[styles.container, { paddingTop: insets.top, paddingBottom: insets.bottom }]}>\n        <Text style={styles.permissionText}>éœ€è¦ç›¸æœºæƒé™</Text>\n        <TouchableOpacity style={styles.button} onPress={requestCameraPermission}>\n          <Text style={styles.buttonText}>æˆäºˆæƒé™</Text>\n        </TouchableOpacity>\n      </View>\n    );\n  }\n\n  // ============ æ¸²æŸ“ ============\n\n  return (\n    <View style={[styles.container, { paddingTop: insets.top, paddingBottom: insets.bottom }]}>\n      {/* æ ‡é¢˜ */}\n      <View style={styles.header}>\n        <Text style={styles.title}>è§†é¢‘æ‹æ‘„</Text>\n        <TouchableOpacity onPress={() => setShowSettings(!showSettings)}>\n          <Text style={styles.settingsIcon}>âš™ï¸</Text>\n        </TouchableOpacity>\n      </View>\n\n      {/* ç›¸æœºé¢„è§ˆ */}\n      <View style={styles.cameraContainer}>\n        <CameraView\n          ref={cameraRef}\n          style={styles.camera}\n          facing={cameraFacing}\n          videoStabilizationMode=\"on\"\n          autofocus=\"on\"\n        />\n\n        {/* å½•åˆ¶æŒ‡ç¤ºå™¨ */}\n        {recording.isRecording && (\n          <View style={styles.recordingIndicator}>\n            <View style={styles.recordingDot} />\n            <Text style={styles.recordingText}>\n              {formatDuration(recording.duration)}\n            </Text>\n          </View>\n        )}\n      </View>\n\n      {/* ç¾é¢œå‚æ•°è°ƒèŠ‚ */}\n      {showSettings && (\n        <ScrollView style={styles.settingsPanel}>\n          <Text style={styles.settingTitle}>ç¾é¢œå‚æ•°</Text>\n\n          {/* ç£¨çš®å¼ºåº¦ */}\n          <View style={styles.paramControl}>\n            <Text style={styles.paramLabel}>ç£¨çš®å¼ºåº¦</Text>\n            <Slider\n              style={styles.slider}\n              minimumValue={0}\n              maximumValue={100}\n              value={beautyParams.smoothing}\n              onValueChange={(value) => handleBeautyParamChange('smoothing', value)}\n              step={1}\n            />\n            <Text style={styles.paramValue}>{beautyParams.smoothing.toFixed(0)}</Text>\n          </View>\n\n          {/* é¥±å’Œåº¦ */}\n          <View style={styles.paramControl}>\n            <Text style={styles.paramLabel}>é¥±å’Œåº¦</Text>\n            <Slider\n              style={styles.slider}\n              minimumValue={0}\n              maximumValue={200}\n              value={beautyParams.saturation}\n              onValueChange={(value) => handleBeautyParamChange('saturation', value)}\n              step={1}\n            />\n            <Text style={styles.paramValue}>{beautyParams.saturation.toFixed(0)}</Text>\n          </View>\n\n          {/* äº®åº¦ */}\n          <View style={styles.paramControl}>\n            <Text style={styles.paramLabel}>äº®åº¦</Text>\n            <Slider\n              style={styles.slider}\n              minimumValue={0}\n              maximumValue={200}\n              value={beautyParams.brightness}\n              onValueChange={(value) => handleBeautyParamChange('brightness', value)}\n              step={1}\n            />\n            <Text style={styles.paramValue}>{beautyParams.brightness.toFixed(0)}</Text>\n          </View>\n\n          {/* æš–è‰²è°ƒ */}\n          <View style={styles.paramControl}>\n            <Text style={styles.paramLabel}>æš–è‰²è°ƒ</Text>\n            <Slider\n              style={styles.slider}\n              minimumValue={-100}\n              maximumValue={100}\n              value={beautyParams.warmth}\n              onValueChange={(value) => handleBeautyParamChange('warmth', value)}\n              step={1}\n            />\n            <Text style={styles.paramValue}>{beautyParams.warmth.toFixed(0)}</Text>\n          </View>\n\n          {/* äº®çœ¼å¼ºåº¦ */}\n          <View style={styles.paramControl}>\n            <Text style={styles.paramLabel}>äº®çœ¼å¼ºåº¦</Text>\n            <Slider\n              style={styles.slider}\n              minimumValue={0}\n              maximumValue={200}\n              value={beautyParams.eyeBrightness}\n              onValueChange={(value) => handleBeautyParamChange('eyeBrightness', value)}\n              step={1}\n            />\n            <Text style={styles.paramValue}>{beautyParams.eyeBrightness.toFixed(0)}</Text>\n          </View>\n\n          {/* ç˜¦è„¸å¼ºåº¦ */}\n          <View style={styles.paramControl}>\n            <Text style={styles.paramLabel}>ç˜¦è„¸å¼ºåº¦</Text>\n            <Slider\n              style={styles.slider}\n              minimumValue={0}\n              maximumValue={100}\n              value={beautyParams.faceThinning}\n              onValueChange={(value) => handleBeautyParamChange('faceThinning', value)}\n              step={1}\n            />\n            <Text style={styles.paramValue}>{beautyParams.faceThinning.toFixed(0)}</Text>\n          </View>\n\n          {/* é‡ç½®æŒ‰é’® */}\n          <TouchableOpacity style={styles.resetButton} onPress={handleResetBeauty}>\n            <Text style={styles.buttonText}>é‡ç½®å‚æ•°</Text>\n          </TouchableOpacity>\n        </ScrollView>\n      )}\n\n      {/* æ§åˆ¶æŒ‰é’® */}\n      <View style={styles.controlsContainer}>\n        {/* ç›¸æœºåˆ‡æ¢ */}\n        <TouchableOpacity style={styles.controlButton} onPress={handleToggleCameraFacing}>\n          <Text style={styles.controlButtonText}>ğŸ”„</Text>\n        </TouchableOpacity>\n\n        {/* å½•åˆ¶/åœæ­¢ */}\n        {!recording.isRecording ? (\n          <TouchableOpacity\n            style={[styles.recordButton, isProcessing && styles.disabledButton]}\n            onPress={handleStartRecording}\n            disabled={isProcessing}\n          >\n            {isProcessing ? (\n              <ActivityIndicator size=\"large\" color=\"#fff\" />\n            ) : (\n              <Text style={styles.recordButtonText}>â—</Text>\n            )}\n          </TouchableOpacity>\n        ) : (\n          <TouchableOpacity\n            style={[styles.stopButton, isProcessing && styles.disabledButton]}\n            onPress={handleStopRecording}\n            disabled={isProcessing}\n          >\n            <Text style={styles.stopButtonText}>â– </Text>\n          </TouchableOpacity>\n        )}\n\n        {/* æš‚åœ/æ¢å¤ */}\n        {recording.isRecording && (\n          <TouchableOpacity style={styles.controlButton} onPress={handlePauseRecording}>\n            <Text style={styles.controlButtonText}>{recording.isPaused ? 'â–¶' : 'â¸'}</Text>\n          </TouchableOpacity>\n        )}\n      </View>\n    </View>\n  );\n}\n\n// ============ æ ·å¼ ============\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: '#000',\n  },\n  header: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    alignItems: 'center',\n    paddingHorizontal: 16,\n    paddingVertical: 12,\n  },\n  title: {\n    fontSize: 24,\n    fontWeight: 'bold',\n    color: '#fff',\n  },\n  settingsIcon: {\n    fontSize: 24,\n  },\n  cameraContainer: {\n    flex: 1,\n    borderRadius: 12,\n    overflow: 'hidden',\n    marginHorizontal: 12,\n    marginVertical: 12,\n  },\n  camera: {\n    flex: 1,\n  },\n  recordingIndicator: {\n    position: 'absolute',\n    top: 16,\n    left: 16,\n    flexDirection: 'row',\n    alignItems: 'center',\n    backgroundColor: 'rgba(0, 0, 0, 0.6)',\n    paddingHorizontal: 12,\n    paddingVertical: 8,\n    borderRadius: 8,\n  },\n  recordingDot: {\n    width: 10,\n    height: 10,\n    borderRadius: 5,\n    backgroundColor: '#ff3b30',\n    marginRight: 8,\n  },\n  recordingText: {\n    color: '#fff',\n    fontSize: 14,\n    fontWeight: 'bold',\n  },\n  settingsPanel: {\n    backgroundColor: '#1a1a1a',\n    maxHeight: 300,\n    paddingHorizontal: 16,\n    paddingVertical: 12,\n  },\n  settingTitle: {\n    fontSize: 16,\n    fontWeight: 'bold',\n    color: '#fff',\n    marginBottom: 12,\n  },\n  paramControl: {\n    marginBottom: 16,\n  },\n  paramLabel: {\n    color: '#fff',\n    fontSize: 14,\n    marginBottom: 8,\n  },\n  slider: {\n    height: 40,\n    marginVertical: 8,\n  },\n  paramValue: {\n    color: '#999',\n    fontSize: 12,\n    textAlign: 'right',\n  },\n  resetButton: {\n    backgroundColor: '#333',\n    paddingVertical: 12,\n    borderRadius: 8,\n    alignItems: 'center',\n    marginBottom: 16,\n  },\n  controlsContainer: {\n    flexDirection: 'row',\n    justifyContent: 'center',\n    alignItems: 'center',\n    paddingVertical: 16,\n    gap: 16,\n  },\n  controlButton: {\n    width: 50,\n    height: 50,\n    borderRadius: 25,\n    backgroundColor: '#333',\n    justifyContent: 'center',\n    alignItems: 'center',\n  },\n  controlButtonText: {\n    fontSize: 24,\n    color: '#fff',\n  },\n  recordButton: {\n    width: 70,\n    height: 70,\n    borderRadius: 35,\n    backgroundColor: '#ff3b30',\n    justifyContent: 'center',\n    alignItems: 'center',\n  },\n  recordButtonText: {\n    fontSize: 40,\n    color: '#fff',\n  },\n  stopButton: {\n    width: 70,\n    height: 70,\n    borderRadius: 35,\n    backgroundColor: '#ff3b30',\n    justifyContent: 'center',\n    alignItems: 'center',\n  },\n  stopButtonText: {\n    fontSize: 30,\n    color: '#fff',\n  },\n  disabledButton: {\n    opacity: 0.5,\n  },\n  button: {\n    backgroundColor: '#007AFF',\n    paddingVertical: 12,\n    paddingHorizontal: 24,\n    borderRadius: 8,\n    alignItems: 'center',\n  },\n  buttonText: {\n    color: '#fff',\n    fontSize: 14,\n    fontWeight: '600',\n  },\n  permissionText: {\n    color: '#fff',\n    fontSize: 16,\n    marginBottom: 16,\n    textAlign: 'center',\n  },\n});\n
