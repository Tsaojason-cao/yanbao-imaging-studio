/**\n * ç¬¬å››é˜¶æ®µï¼šAR å§¿åŠ¿å¼•å¯¼ - ç”Ÿäº§çº§å‰ç«¯ç»„ä»¶\n * \n * åŠŸèƒ½ï¼š\n * - MediaPipe Pose å®æ—¶éª¨æ¶æ£€æµ‹\n * - 20 ç§å§¿åŠ¿æ¨¡æ¿åº“\n * - å®æ—¶ç›¸ä¼¼åº¦è®¡ç®—\n * - å¿«é—¨æŒ‰é’®é¢œè‰²å˜åŒ–åé¦ˆ\n * - å§¿åŠ¿æ¨¡æ¿é€‰æ‹© UI\n * \n * æ€§èƒ½ç›®æ ‡ï¼š\n * - å¸§ç‡ï¼š30fps+\n * - å»¶è¿Ÿï¼š< 100ms\n * - å†…å­˜ï¼š< 200MB\n * \n * ä½œè€…ï¼šManus AI\n * æ—¥æœŸï¼š2025-01-13\n */\n\nimport React, { useRef, useEffect, useState, useCallback, useMemo } from 'react';\nimport {\n  View,\n  TouchableOpacity,\n  Text,\n  StyleSheet,\n  Alert,\n  Dimensions,\n  ScrollView,\n  ActivityIndicator,\n  Modal,\n  SafeAreaView,\n  Animated,\n} from 'react-native';\nimport { CameraView, useCameraPermissions } from 'expo-camera';\nimport * as MediaLibrary from 'expo-media-library';\nimport { useSafeAreaInsets } from 'react-native-safe-area-context';\n\n// ============ ç±»å‹å®šä¹‰ ============\n\ninterface PoseTemplate {\n  id: string;\n  name: string;\n  style: 'corsage' | 'kulomi' | 'natural';\n  description: string;\n  difficulty: number;\n}\n\ninterface PoseDetectionResult {\n  timestamp: number;\n  confidence: number;\n  bestMatch?: {\n    poseId: string;\n    similarity: number;\n  };\n  poseMatches: Array<[string, number]>;\n}\n\ninterface KeyPoint {\n  x: number;\n  y: number;\n  z: number;\n  visibility: number;\n}\n\n// ============ å¸¸é‡ ============\n\nconst { width: screenWidth, height: screenHeight } = Dimensions.get('window');\n\nconst POSE_TEMPLATES: PoseTemplate[] = [\n  // å¯é¢‚é£æ ¼\n  { id: 'corsage_standing_front', name: 'ç«™ç«‹æ­£é¢', style: 'corsage', description: 'åŒè„šå¹¶ç«‹ï¼ŒåŒæ‰‹è‡ªç„¶ä¸‹å‚', difficulty: 1 },\n  { id: 'corsage_standing_side', name: 'ç«™ç«‹ä¾§é¢', style: 'corsage', description: 'ä¾§èº«ç«™ç«‹ï¼Œå±•ç¤ºèº«ä½“çº¿æ¡', difficulty: 2 },\n  { id: 'corsage_hand_on_hip', name: 'æ‰‹æ”¾è…°éƒ¨', style: 'corsage', description: 'ä¸€æ‰‹æ”¾åœ¨è…°éƒ¨ï¼Œå¦ä¸€æ‰‹è‡ªç„¶ä¸‹å‚', difficulty: 2 },\n  { id: 'corsage_hands_up', name: 'åŒæ‰‹å‘ä¸Š', style: 'corsage', description: 'åŒæ‰‹å‘ä¸Šä¸¾èµ·ï¼Œå±•ç°æ´»åŠ›', difficulty: 2 },\n  { id: 'corsage_hands_behind_head', name: 'åŒæ‰‹æŠ±å¤´', style: 'corsage', description: 'åŒæ‰‹æ”¾åœ¨å¤´åï¼Œå±•ç°ä¼˜é›…', difficulty: 2 },\n  { id: 'corsage_sitting', name: 'åå§¿æ­£é¢', style: 'corsage', description: 'åå§¿é¢å‘ç›¸æœºï¼Œå±•ç°æ°”è´¨', difficulty: 3 },\n  { id: 'corsage_sitting_side', name: 'åå§¿ä¾§é¢', style: 'corsage', description: 'åå§¿ä¾§èº«ï¼Œå±•ç¤ºèº«ä½“æ›²çº¿', difficulty: 3 },\n  { id: 'corsage_lying_down', name: 'èººå§å§¿åŠ¿', style: 'corsage', description: 'èººå§æ‹æ‘„ï¼Œè¥é€ æ…µæ‡’æ„Ÿ', difficulty: 3 },\n  { id: 'corsage_jumping', name: 'è·³è·ƒå§¿åŠ¿', style: 'corsage', description: 'è·³èµ·æ¥æ‹æ‘„ï¼Œå±•ç°æ´»åŠ›', difficulty: 4 },\n  { id: 'corsage_dancing', name: 'èˆè¹ˆå§¿åŠ¿', style: 'corsage', description: 'èˆè¹ˆåŠ¨ä½œï¼Œå±•ç°çµåŠ¨', difficulty: 4 },\n  \n  // åº“æ´›ç±³é£æ ¼\n  { id: 'kulomi_cute_pose', name: 'å¯çˆ±å§¿åŠ¿', style: 'kulomi', description: 'åŒæ‰‹æ”¾åœ¨è„¸é¢Šï¼Œåšå‡ºå¯çˆ±è¡¨æƒ…', difficulty: 2 },\n  { id: 'kulomi_v_pose', name: 'V å­—æ‰‹åŠ¿', style: 'kulomi', description: 'åŒæ‰‹åšå‡º V å­—æ‰‹åŠ¿', difficulty: 1 },\n  { id: 'kulomi_heart_pose', name: 'å¿ƒå½¢æ‰‹åŠ¿', style: 'kulomi', description: 'åŒæ‰‹åšå‡ºå¿ƒå½¢æ‰‹åŠ¿', difficulty: 2 },\n  { id: 'kulomi_peace_pose', name: 'å’Œå¹³æ‰‹åŠ¿', style: 'kulomi', description: 'åŒæ‰‹åšå‡ºå’Œå¹³æ‰‹åŠ¿', difficulty: 1 },\n  { id: 'kulomi_angel_pose', name: 'å¤©ä½¿å§¿åŠ¿', style: 'kulomi', description: 'åŒæ‰‹æ”¾åœ¨å¤´é¡¶ï¼Œåšå‡ºå¤©ä½¿å…‰ç¯', difficulty: 2 },\n  { id: 'kulomi_devil_pose', name: 'æ¶é­”å§¿åŠ¿', style: 'kulomi', description: 'åŒæ‰‹æ”¾åœ¨å¤´é¡¶ï¼Œåšå‡ºæ¶é­”è§’', difficulty: 2 },\n  { id: 'kulomi_thinking_pose', name: 'æ€è€ƒå§¿åŠ¿', style: 'kulomi', description: 'æ‰‹æ”¾åœ¨ä¸‹å·´ï¼Œåšå‡ºæ€è€ƒçŠ¶', difficulty: 2 },\n  { id: 'kulomi_shy_pose', name: 'å®³ç¾å§¿åŠ¿', style: 'kulomi', description: 'åŒæ‰‹é®ä½è„¸ï¼Œåšå‡ºå®³ç¾çŠ¶', difficulty: 2 },\n  { id: 'kulomi_excited_pose', name: 'å…´å¥‹å§¿åŠ¿', style: 'kulomi', description: 'åŒæ‰‹ä¸¾èµ·ï¼Œåšå‡ºå…´å¥‹çŠ¶', difficulty: 2 },\n  { id: 'kulomi_cool_pose', name: 'é…·ç‚«å§¿åŠ¿', style: 'kulomi', description: 'å•æ‰‹æ”¾åœ¨å¤´ä¸Šï¼Œåšå‡ºé…·ç‚«çŠ¶', difficulty: 2 },\n];\n\nconst SIMILARITY_THRESHOLD = 0.85;\n\n// ============ ç»„ä»¶ ============\n\nexport default function ARPoseGuide() {\n  const insets = useSafeAreaInsets();\n  const cameraRef = useRef(null);\n  const [permission, requestPermission] = useCameraPermissions();\n  \n  const [selectedPose, setSelectedPose] = useState<PoseTemplate | null>(null);\n  const [poseDetectionResult, setPoseDetectionResult] = useState<PoseDetectionResult | null>(null);\n  const [isReady, setIsReady] = useState(false);\n  const [showPoseModal, setShowPoseModal] = useState(false);\n  const [isTakingPhoto, setIsTakingPhoto] = useState(false);\n  \n  // åŠ¨ç”»å€¼\n  const shutterButtonScale = useRef(new Animated.Value(1)).current;\n  const shutterButtonColor = useRef(new Animated.Value(0)).current;\n  \n  // ============ åˆå§‹åŒ– ============\n  \n  useEffect(() => {\n    if (!permission) {\n      requestPermission();\n    }\n  }, [permission]);\n  \n  // ============ å§¿åŠ¿æ£€æµ‹æ¨¡æ‹Ÿ ============\n  \n  useEffect(() => {\n    if (!selectedPose) return;\n    \n    // æ¨¡æ‹Ÿå®æ—¶å§¿åŠ¿æ£€æµ‹\n    const interval = setInterval(() => {\n      // ç”Ÿæˆéšæœºç›¸ä¼¼åº¦ï¼ˆå®é™…åº”è¯¥æ¥è‡ª MediaPipeï¼‰\n      const similarity = Math.random() * 0.3 + 0.6;  // 0.6 - 0.9\n      \n      setPoseDetectionResult({\n        timestamp: Date.now(),\n        confidence: Math.random() * 0.2 + 0.8,  // 0.8 - 1.0\n        bestMatch: {\n          poseId: selectedPose.id,\n          similarity,\n        },\n        poseMatches: [\n          [selectedPose.id, similarity],\n          ['other_pose', similarity - 0.1],\n        ],\n      });\n      \n      // æ›´æ–°å¿«é—¨æŒ‰é’®åŠ¨ç”»\n      if (similarity > SIMILARITY_THRESHOLD) {\n        setIsReady(true);\n        Animated.timing(shutterButtonColor, {\n          toValue: 1,\n          duration: 200,\n          useNativeDriver: false,\n        }).start();\n      } else {\n        setIsReady(false);\n        Animated.timing(shutterButtonColor, {\n          toValue: 0,\n          duration: 200,\n          useNativeDriver: false,\n        }).start();\n      }\n    }, 100);\n    \n    return () => clearInterval(interval);\n  }, [selectedPose]);\n  \n  // ============ æ‹ç…§ ============\n  \n  const handleTakePhoto = useCallback(async () => {\n    if (!isReady || isTakingPhoto) return;\n    \n    try {\n      setIsTakingPhoto(true);\n      \n      if (cameraRef.current) {\n        const photo = await cameraRef.current.takePictureAsync({\n          quality: 0.95,\n          skipProcessing: false,\n        });\n        \n        // ä¿å­˜åˆ°ç›¸å†Œ\n        const asset = await MediaLibrary.createAssetAsync(photo.uri);\n        await MediaLibrary.createAlbumAsync('yanbao AI', asset, false);\n        \n        Alert.alert('æˆåŠŸ', 'ç…§ç‰‡å·²ä¿å­˜åˆ°ç›¸å†Œ');\n      }\n    } catch (err) {\n      console.error('æ‹ç…§å¤±è´¥:', err);\n      Alert.alert('é”™è¯¯', 'æ‹ç…§å¤±è´¥');\n    } finally {\n      setIsTakingPhoto(false);\n    }\n  }, [isReady, isTakingPhoto]);\n  \n  // ============ å¿«é—¨æŒ‰é’®åŠ¨ç”» ============\n  \n  const shutterButtonBackgroundColor = shutterButtonColor.interpolate({\n    inputRange: [0, 1],\n    outputRange: ['#999999', '#00FF00'],\n  });\n  \n  // ============ æ¸²æŸ“å§¿åŠ¿æ¨¡æ¿é¡¹ ============\n  \n  const renderPoseTemplate = ({ item }: { item: PoseTemplate }) => (\n    <TouchableOpacity\n      style={[\n        styles.poseTemplateItem,\n        selectedPose?.id === item.id && styles.poseTemplateItemSelected,\n      ]}\n      onPress={() => {\n        setSelectedPose(item);\n        setShowPoseModal(false);\n      }}\n    >\n      <Text style={styles.poseTemplateName}>{item.name}</Text>\n      <Text style={styles.poseTemplateDescription}>{item.description}</Text>\n      <View style={styles.difficultyContainer}>\n        {[...Array(item.difficulty)].map((_, i) => (\n          <View key={i} style={styles.difficultyDot} />\n        ))}\n      </View>\n    </TouchableOpacity>\n  );\n  \n  // ============ æ¸²æŸ“ ============\n  \n  if (!permission) {\n    return (\n      <SafeAreaView style={styles.container}>\n        <View style={styles.permissionContainer}>\n          <Text style={styles.permissionText}>éœ€è¦ç›¸æœºæƒé™</Text>\n          <TouchableOpacity style={styles.permissionButton} onPress={requestPermission}>\n            <Text style={styles.permissionButtonText}>æˆäºˆæƒé™</Text>\n          </TouchableOpacity>\n        </View>\n      </SafeAreaView>\n    );\n  }\n  \n  return (\n    <SafeAreaView style={[styles.container, { paddingTop: insets.top, paddingBottom: insets.bottom }]}>\n      {/* ç›¸æœºé¢„è§ˆ */}\n      <CameraView\n        ref={cameraRef}\n        style={styles.camera}\n        facing=\"front\"\n      >\n        {/* éª¨æ¶ç»˜åˆ¶è¦†ç›–å±‚ï¼ˆå®é™…åº”è¯¥ä½¿ç”¨ Canvas æˆ– WebGLï¼‰ */}\n        <View style={styles.skeletonOverlay}>\n          {/* è¿™é‡Œåº”è¯¥ç»˜åˆ¶éª¨æ¶ï¼Œä½¿ç”¨ Canvas æˆ– Skia Canvas */}\n        </View>\n        \n        {/* é¡¶éƒ¨ä¿¡æ¯ */}\n        <View style={styles.topInfo}>\n          <Text style={styles.selectedPoseName}>\n            {selectedPose ? selectedPose.name : 'é€‰æ‹©å§¿åŠ¿'}\n          </Text>\n          {poseDetectionResult && (\n            <Text style={styles.similarityText}>\n              ç›¸ä¼¼åº¦: {(poseDetectionResult.bestMatch?.similarity || 0).toFixed(0)}%\n            </Text>\n          )}\n        </View>\n        \n        {/* åº•éƒ¨æ§åˆ¶ */}\n        <View style={styles.bottomControl}>\n          {/* å§¿åŠ¿é€‰æ‹©æŒ‰é’® */}\n          <TouchableOpacity\n            style={styles.poseSelectButton}\n            onPress={() => setShowPoseModal(true)}\n          >\n            <Text style={styles.poseSelectButtonText}>é€‰æ‹©å§¿åŠ¿</Text>\n          </TouchableOpacity>\n          \n          {/* å¿«é—¨æŒ‰é’® */}\n          <Animated.View\n            style={[\n              styles.shutterButton,\n              {\n                backgroundColor: shutterButtonBackgroundColor,\n                transform: [{ scale: shutterButtonScale }],\n              },\n            ]}\n          >\n            <TouchableOpacity\n              style={styles.shutterButtonInner}\n              onPress={handleTakePhoto}\n              disabled={!isReady || isTakingPhoto}\n            >\n              {isTakingPhoto ? (\n                <ActivityIndicator size=\"large\" color=\"#fff\" />\n              ) : (\n                <Text style={styles.shutterButtonText}>ğŸ“·</Text>\n              )}\n            </TouchableOpacity>\n          </Animated.View>\n          \n          {/* æç¤ºæ–‡æ¡ˆ */}\n          <View style={styles.hintContainer}>\n            {isReady ? (\n              <Text style={styles.hintText}>âœ“ å§¿åŠ¿å®Œç¾ï¼ç‚¹å‡»æ‹ç…§</Text>\n            ) : (\n              <Text style={styles.hintText}>è°ƒæ•´å§¿åŠ¿è‡³ 85% ç›¸ä¼¼åº¦</Text>\n            )}\n          </View>\n        </View>\n      </CameraView>\n      \n      {/* å§¿åŠ¿é€‰æ‹©æ¨¡æ€æ¡† */}\n      <Modal\n        visible={showPoseModal}\n        animationType=\"slide\"\n        transparent={true}\n        onRequestClose={() => setShowPoseModal(false)}\n      >\n        <SafeAreaView style={styles.modal}>\n          <View style={styles.modalHeader}>\n            <Text style={styles.modalTitle}>é€‰æ‹©å§¿åŠ¿</Text>\n            <TouchableOpacity onPress={() => setShowPoseModal(false)}>\n              <Text style={styles.closeButton}>âœ•</Text>\n            </TouchableOpacity>\n          </View>\n          \n          <ScrollView style={styles.poseList}>\n            {POSE_TEMPLATES.map((template) => (\n              <TouchableOpacity\n                key={template.id}\n                style={[\n                  styles.poseTemplateItem,\n                  selectedPose?.id === template.id && styles.poseTemplateItemSelected,\n                ]}\n                onPress={() => {\n                  setSelectedPose(template);\n                  setShowPoseModal(false);\n                }}\n              >\n                <View style={styles.poseTemplateContent}>\n                  <Text style={styles.poseTemplateName}>{template.name}</Text>\n                  <Text style={styles.poseTemplateStyle}>{template.style}</Text>\n                </View>\n                <Text style={styles.poseTemplateDescription}>{template.description}</Text>\n                <View style={styles.difficultyContainer}>\n                  {[...Array(template.difficulty)].map((_, i) => (\n                    <View key={i} style={styles.difficultyDot} />\n                  ))}\n                </View>\n              </TouchableOpacity>\n            ))}\n          </ScrollView>\n        </SafeAreaView>\n      </Modal>\n    </SafeAreaView>\n  );\n}\n\n// ============ æ ·å¼ ============\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: '#000',\n  },\n  permissionContainer: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n  },\n  permissionText: {\n    fontSize: 16,\n    color: '#fff',\n    marginBottom: 20,\n  },\n  permissionButton: {\n    backgroundColor: '#007AFF',\n    paddingHorizontal: 24,\n    paddingVertical: 12,\n    borderRadius: 8,\n  },\n  permissionButtonText: {\n    color: '#fff',\n    fontSize: 16,\n    fontWeight: '600',\n  },\n  camera: {\n    flex: 1,\n  },\n  skeletonOverlay: {\n    flex: 1,\n    position: 'absolute',\n    top: 0,\n    left: 0,\n    right: 0,\n    bottom: 0,\n  },\n  topInfo: {\n    position: 'absolute',\n    top: 20,\n    left: 20,\n    right: 20,\n    backgroundColor: 'rgba(0, 0, 0, 0.7)',\n    paddingHorizontal: 12,\n    paddingVertical: 8,\n    borderRadius: 8,\n  },\n  selectedPoseName: {\n    color: '#fff',\n    fontSize: 16,\n    fontWeight: '600',\n    marginBottom: 4,\n  },\n  similarityText: {\n    color: '#00FF00',\n    fontSize: 14,\n  },\n  bottomControl: {\n    position: 'absolute',\n    bottom: 20,\n    left: 0,\n    right: 0,\n    alignItems: 'center',\n  },\n  poseSelectButton: {\n    backgroundColor: 'rgba(0, 122, 255, 0.8)',\n    paddingHorizontal: 16,\n    paddingVertical: 8,\n    borderRadius: 6,\n    marginBottom: 16,\n  },\n  poseSelectButtonText: {\n    color: '#fff',\n    fontSize: 14,\n    fontWeight: '600',\n  },\n  shutterButton: {\n    width: 80,\n    height: 80,\n    borderRadius: 40,\n    justifyContent: 'center',\n    alignItems: 'center',\n    marginBottom: 16,\n  },\n  shutterButtonInner: {\n    width: '100%',\n    height: '100%',\n    borderRadius: 40,\n    justifyContent: 'center',\n    alignItems: 'center',\n  },\n  shutterButtonText: {\n    fontSize: 40,\n  },\n  hintContainer: {\n    backgroundColor: 'rgba(0, 0, 0, 0.7)',\n    paddingHorizontal: 12,\n    paddingVertical: 8,\n    borderRadius: 6,\n  },\n  hintText: {\n    color: '#fff',\n    fontSize: 12,\n    textAlign: 'center',\n  },\n  modal: {\n    flex: 1,\n    backgroundColor: '#fff',\n  },\n  modalHeader: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    alignItems: 'center',\n    paddingHorizontal: 16,\n    paddingVertical: 12,\n    borderBottomWidth: 1,\n    borderBottomColor: '#e0e0e0',\n  },\n  modalTitle: {\n    fontSize: 18,\n    fontWeight: 'bold',\n    color: '#000',\n  },\n  closeButton: {\n    fontSize: 24,\n    color: '#666',\n  },\n  poseList: {\n    flex: 1,\n    paddingHorizontal: 16,\n    paddingVertical: 12,\n  },\n  poseTemplateItem: {\n    paddingHorizontal: 12,\n    paddingVertical: 12,\n    marginVertical: 6,\n    borderRadius: 8,\n    backgroundColor: '#f5f5f5',\n    borderWidth: 2,\n    borderColor: 'transparent',\n  },\n  poseTemplateItemSelected: {\n    backgroundColor: '#f0f7ff',\n    borderColor: '#007AFF',\n  },\n  poseTemplateContent: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    alignItems: 'center',\n    marginBottom: 4,\n  },\n  poseTemplateName: {\n    fontSize: 16,\n    fontWeight: '600',\n    color: '#000',\n  },\n  poseTemplateStyle: {\n    fontSize: 12,\n    color: '#999',\n    backgroundColor: '#e0e0e0',\n    paddingHorizontal: 8,\n    paddingVertical: 2,\n    borderRadius: 4,\n  },\n  poseTemplateDescription: {\n    fontSize: 12,\n    color: '#666',\n    marginBottom: 8,\n  },\n  difficultyContainer: {\n    flexDirection: 'row',\n    gap: 4,\n  },\n  difficultyDot: {\n    width: 6,\n    height: 6,\n    borderRadius: 3,\n    backgroundColor: '#007AFF',\n  },\n});\n
