/**\n * ç¬¬äº”é˜¶æ®µï¼šAI æ‰©å›¾ï¼ˆOutpainting / Generative Fillï¼‰- ç”Ÿäº§çº§å‰ç«¯ç»„ä»¶\n * \n * åŠŸèƒ½ï¼š\n * - å›¾ç‰‡ç¼–è¾‘ UIï¼ˆæ‹–åŠ¨è¾¹ç¼˜æ‰©å±•ï¼‰\n * - æ‰©å±•æ–¹å‘é€‰æ‹©ï¼ˆä¸Šä¸‹å·¦å³ã€å¯¹è§’çº¿ã€è‡ªç”±æ‹–åŠ¨ï¼‰\n * - æ‰©å±•æ¯”ä¾‹æ§åˆ¶ï¼ˆ1.5xã€2xã€3xã€è‡ªå®šä¹‰ï¼‰\n * - å®æ—¶é¢„è§ˆ\n * - ä¿å­˜åŠŸèƒ½\n * \n * æ€§èƒ½ç›®æ ‡ï¼š\n * - ç”Ÿæˆæ—¶é—´ï¼š< 10ç§’\n * - å†…å­˜å ç”¨ï¼š< 500MB\n * - è´¨é‡ï¼šé«˜è´¨é‡\n * \n * ä½œè€…ï¼šManus AI\n * æ—¥æœŸï¼š2025-01-13\n */\n\nimport React, { useRef, useEffect, useState, useCallback, useMemo } from 'react';\nimport {\n  View,\n  TouchableOpacity,\n  Text,\n  StyleSheet,\n  Alert,\n  Dimensions,\n  ScrollView,\n  ActivityIndicator,\n  Modal,\n  SafeAreaView,\n  Animated,\n  Image as RNImage,\n  PanResponder,\n  GestureResponderEvent,\n  PanResponderGestureState,\n} from 'react-native';\nimport * as ImagePicker from 'expo-image-picker';\nimport * as MediaLibrary from 'expo-media-library';\nimport { useSafeAreaInsets } from 'react-native-safe-area-context';\nimport Slider from '@react-native-community/slider';\n\n// ============ ç±»å‹å®šä¹‰ ============\n\ntype ExtensionDirection = 'up' | 'down' | 'left' | 'right' | 'up_left' | 'up_right' | 'down_left' | 'down_right' | 'custom';\n\ninterface OutpaintingRequest {\n  imageUri: string;\n  direction: ExtensionDirection;\n  scale: number;\n  numSteps?: number;\n  guidanceScale?: number;\n}\n\ninterface OutpaintingResult {\n  taskId: string;\n  generatedImageUri: string;\n  generationTimeMs: number;\n  status: 'completed' | 'failed';\n  errorMessage?: string;\n}\n\n// ============ å¸¸é‡ ============\n\nconst { width: screenWidth, height: screenHeight } = Dimensions.get('window');\n\nconst EXTENSION_DIRECTIONS: Array<{ id: ExtensionDirection; name: string; icon: string }> = [\n  { id: 'up', name: 'å‘ä¸Š', icon: 'â¬†ï¸' },\n  { id: 'down', name: 'å‘ä¸‹', icon: 'â¬‡ï¸' },\n  { id: 'left', name: 'å‘å·¦', icon: 'â¬…ï¸' },\n  { id: 'right', name: 'å‘å³', icon: 'â¡ï¸' },\n  { id: 'up_left', name: 'å·¦ä¸Š', icon: 'â†–ï¸' },\n  { id: 'up_right', name: 'å³ä¸Š', icon: 'â†—ï¸' },\n  { id: 'down_left', name: 'å·¦ä¸‹', icon: 'â†™ï¸' },\n  { id: 'down_right', name: 'å³ä¸‹', icon: 'â†˜ï¸' },\n];\n\nconst SCALE_OPTIONS = [1.5, 2.0, 3.0];\n\n// ============ ç»„ä»¶ ============\n\nexport default function AIOutpainting() {\n  const insets = useSafeAreaInsets();\n  const [selectedImage, setSelectedImage] = useState<string | null>(null);\n  const [selectedDirection, setSelectedDirection] = useState<ExtensionDirection>('right');\n  const [selectedScale, setSelectedScale] = useState<number>(1.5);\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [generatedImage, setGeneratedImage] = useState<string | null>(null);\n  const [generationProgress, setGenerationProgress] = useState(0);\n  const [showDirectionModal, setShowDirectionModal] = useState(false);\n  const [showScaleModal, setShowScaleModal] = useState(false);\n  \n  // åŠ¨ç”»å€¼\n  const progressAnimation = useRef(new Animated.Value(0)).current;\n  \n  // ============ åˆå§‹åŒ– ============\n  \n  useEffect(() => {\n    requestImagePermission();\n  }, []);\n  \n  // ============ æƒé™è¯·æ±‚ ============\n  \n  const requestImagePermission = async () => {\n    const { status } = await ImagePicker.requestMediaLibraryPermissionsAsync();\n    if (status !== 'granted') {\n      Alert.alert('æƒé™ä¸è¶³', 'éœ€è¦ç›¸å†Œè®¿é—®æƒé™');\n    }\n  };\n  \n  // ============ é€‰æ‹©å›¾ç‰‡ ============\n  \n  const handlePickImage = useCallback(async () => {\n    try {\n      const result = await ImagePicker.launchImageLibraryAsync({\n        mediaTypes: ImagePicker.MediaTypeOptions.Images,\n        allowsEditing: false,\n        aspect: [1, 1],\n        quality: 1,\n      });\n      \n      if (!result.canceled) {\n        setSelectedImage(result.assets[0].uri);\n        setGeneratedImage(null);\n      }\n    } catch (err) {\n      console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥:', err);\n      Alert.alert('é”™è¯¯', 'é€‰æ‹©å›¾ç‰‡å¤±è´¥');\n    }\n  }, []);\n  \n  // ============ ç”Ÿæˆæ‰©å›¾ ============\n  \n  const handleGenerateOutpainting = useCallback(async () => {\n    if (!selectedImage) {\n      Alert.alert('æç¤º', 'è¯·å…ˆé€‰æ‹©å›¾ç‰‡');\n      return;\n    }\n    \n    try {\n      setIsGenerating(true);\n      setGenerationProgress(0);\n      \n      // æ¨¡æ‹Ÿç”Ÿæˆè¿‡ç¨‹\n      const progressInterval = setInterval(() => {\n        setGenerationProgress((prev) => {\n          const next = prev + Math.random() * 30;\n          return next > 90 ? 90 : next;\n        });\n      }, 500);\n      \n      // æ¨¡æ‹Ÿ API è°ƒç”¨\n      await new Promise((resolve) => setTimeout(resolve, 5000));\n      \n      clearInterval(progressInterval);\n      setGenerationProgress(100);\n      \n      // æ¨¡æ‹Ÿç”Ÿæˆç»“æœï¼ˆå®é™…åº”è¯¥æ¥è‡ªåç«¯ï¼‰\n      setGeneratedImage(selectedImage);  // è¿™é‡Œåº”è¯¥æ˜¯ç”Ÿæˆçš„å›¾ç‰‡\n      \n      Alert.alert('æˆåŠŸ', 'æ‰©å›¾ç”Ÿæˆå®Œæˆï¼');\n    } catch (err) {\n      console.error('ç”Ÿæˆæ‰©å›¾å¤±è´¥:', err);\n      Alert.alert('é”™è¯¯', 'ç”Ÿæˆæ‰©å›¾å¤±è´¥');\n    } finally {\n      setIsGenerating(false);\n      setGenerationProgress(0);\n    }\n  }, [selectedImage]);\n  \n  // ============ ä¿å­˜å›¾ç‰‡ ============\n  \n  const handleSaveImage = useCallback(async () => {\n    if (!generatedImage) {\n      Alert.alert('æç¤º', 'æ²¡æœ‰å¯ä¿å­˜çš„å›¾ç‰‡');\n      return;\n    }\n    \n    try {\n      const asset = await MediaLibrary.createAssetAsync(generatedImage);\n      await MediaLibrary.createAlbumAsync('yanbao AI', asset, false);\n      Alert.alert('æˆåŠŸ', 'å›¾ç‰‡å·²ä¿å­˜åˆ°ç›¸å†Œ');\n    } catch (err) {\n      console.error('ä¿å­˜å›¾ç‰‡å¤±è´¥:', err);\n      Alert.alert('é”™è¯¯', 'ä¿å­˜å›¾ç‰‡å¤±è´¥');\n    }\n  }, [generatedImage]);\n  \n  // ============ è¿›åº¦åŠ¨ç”» ============\n  \n  useEffect(() => {\n    Animated.timing(progressAnimation, {\n      toValue: generationProgress,\n      duration: 300,\n      useNativeDriver: false,\n    }).start();\n  }, [generationProgress]);\n  \n  const progressWidth = progressAnimation.interpolate({\n    inputRange: [0, 100],\n    outputRange: ['0%', '100%'],\n  });\n  \n  // ============ æ¸²æŸ“ ============\n  \n  return (\n    <SafeAreaView style={[styles.container, { paddingTop: insets.top, paddingBottom: insets.bottom }]}>\n      <ScrollView style={styles.scrollView} showsVerticalScrollIndicator={false}>\n        {/* æ ‡é¢˜ */}\n        <Text style={styles.title}>AI æ‰©å›¾</Text>\n        <Text style={styles.subtitle}>ä½¿ç”¨ AI æ‰©å±•å›¾ç‰‡ï¼Œåˆ›é€ æ— é™å¯èƒ½</Text>\n        \n        {/* å›¾ç‰‡é¢„è§ˆåŒº */}\n        <View style={styles.imagePreviewContainer}>\n          {selectedImage ? (\n            <RNImage\n              source={{ uri: selectedImage }}\n              style={styles.imagePreview}\n              resizeMode=\"contain\"\n            />\n          ) : (\n            <View style={styles.imagePlaceholder}>\n              <Text style={styles.placeholderText}>ğŸ“·</Text>\n              <Text style={styles.placeholderText2}>ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</Text>\n            </View>\n          )}\n          \n          <TouchableOpacity\n            style={styles.selectImageButton}\n            onPress={handlePickImage}\n          >\n            <Text style={styles.selectImageButtonText}>é€‰æ‹©å›¾ç‰‡</Text>\n          </TouchableOpacity>\n        </View>\n        \n        {/* æ‰©å±•æ–¹å‘é€‰æ‹© */}\n        <View style={styles.section}>\n          <Text style={styles.sectionTitle}>æ‰©å±•æ–¹å‘</Text>\n          <TouchableOpacity\n            style={styles.directionDisplay}\n            onPress={() => setShowDirectionModal(true)}\n          >\n            <Text style={styles.directionDisplayIcon}>\n              {EXTENSION_DIRECTIONS.find((d) => d.id === selectedDirection)?.icon}\n            </Text>\n            <Text style={styles.directionDisplayText}>\n              {EXTENSION_DIRECTIONS.find((d) => d.id === selectedDirection)?.name}\n            </Text>\n          </TouchableOpacity>\n        </View>\n        \n        {/* æ‰©å±•æ¯”ä¾‹é€‰æ‹© */}\n        <View style={styles.section}>\n          <Text style={styles.sectionTitle}>æ‰©å±•æ¯”ä¾‹</Text>\n          <View style={styles.scaleOptions}>\n            {SCALE_OPTIONS.map((scale) => (\n              <TouchableOpacity\n                key={scale}\n                style={[\n                  styles.scaleOption,\n                  selectedScale === scale && styles.scaleOptionSelected,\n                ]}\n                onPress={() => setSelectedScale(scale)}\n              >\n                <Text\n                  style={[\n                    styles.scaleOptionText,\n                    selectedScale === scale && styles.scaleOptionTextSelected,\n                  ]}\n                >\n                  {scale}x\n                </Text>\n              </TouchableOpacity>\n            ))}\n          </View>\n          \n          {/* è‡ªå®šä¹‰æ¯”ä¾‹æ»‘å— */}\n          <View style={styles.customScaleContainer}>\n            <Text style={styles.customScaleLabel}>è‡ªå®šä¹‰: {selectedScale.toFixed(1)}x</Text>\n            <Slider\n              style={styles.slider}\n              minimumValue={1.0}\n              maximumValue={4.0}\n              step={0.1}\n              value={selectedScale}\n              onValueChange={setSelectedScale}\n              minimumTrackTintColor=\"#007AFF\"\n              maximumTrackTintColor=\"#e0e0e0\"\n            />\n          </View>\n        </View>\n        \n        {/* ç”Ÿæˆè¿›åº¦ */}\n        {isGenerating && (\n          <View style={styles.progressContainer}>\n            <Text style={styles.progressText}>æ­£åœ¨ç”Ÿæˆæ‰©å›¾...</Text>\n            <View style={styles.progressBar}>\n              <Animated.View\n                style={[\n                  styles.progressFill,\n                  { width: progressWidth },\n                ]}\n              />\n            </View>\n            <Text style={styles.progressPercentage}>{Math.round(generationProgress)}%</Text>\n          </View>\n        )}\n        \n        {/* ç”Ÿæˆç»“æœé¢„è§ˆ */}\n        {generatedImage && (\n          <View style={styles.resultContainer}>\n            <Text style={styles.resultTitle}>ç”Ÿæˆç»“æœ</Text>\n            <RNImage\n              source={{ uri: generatedImage }}\n              style={styles.resultImage}\n              resizeMode=\"contain\"\n            />\n            <TouchableOpacity\n              style={styles.saveButton}\n              onPress={handleSaveImage}\n            >\n              <Text style={styles.saveButtonText}>ğŸ’¾ ä¿å­˜åˆ°ç›¸å†Œ</Text>\n            </TouchableOpacity>\n          </View>\n        )}\n        \n        {/* ç”ŸæˆæŒ‰é’® */}\n        <TouchableOpacity\n          style={[\n            styles.generateButton,\n            isGenerating && styles.generateButtonDisabled,\n          ]}\n          onPress={handleGenerateOutpainting}\n          disabled={isGenerating || !selectedImage}\n        >\n          {isGenerating ? (\n            <ActivityIndicator size=\"large\" color=\"#fff\" />\n          ) : (\n            <Text style={styles.generateButtonText}>âœ¨ å¼€å§‹æ‰©å›¾</Text>\n          )}\n        </TouchableOpacity>\n      </ScrollView>\n      \n      {/* æ–¹å‘é€‰æ‹©æ¨¡æ€æ¡† */}\n      <Modal\n        visible={showDirectionModal}\n        animationType=\"slide\"\n        transparent={true}\n        onRequestClose={() => setShowDirectionModal(false)}\n      >\n        <SafeAreaView style={styles.modal}>\n          <View style={styles.modalHeader}>\n            <Text style={styles.modalTitle}>é€‰æ‹©æ‰©å±•æ–¹å‘</Text>\n            <TouchableOpacity onPress={() => setShowDirectionModal(false)}>\n              <Text style={styles.closeButton}>âœ•</Text>\n            </TouchableOpacity>\n          </View>\n          \n          <View style={styles.directionsGrid}>\n            {EXTENSION_DIRECTIONS.map((direction) => (\n              <TouchableOpacity\n                key={direction.id}\n                style={[\n                  styles.directionItem,\n                  selectedDirection === direction.id && styles.directionItemSelected,\n                ]}\n                onPress={() => {\n                  setSelectedDirection(direction.id);\n                  setShowDirectionModal(false);\n                }}\n              >\n                <Text style={styles.directionItemIcon}>{direction.icon}</Text>\n                <Text style={styles.directionItemName}>{direction.name}</Text>\n              </TouchableOpacity>\n            ))}\n          </View>\n        </SafeAreaView>\n      </Modal>\n    </SafeAreaView>\n  );\n}\n\n// ============ æ ·å¼ ============\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: '#fff',\n  },\n  scrollView: {\n    flex: 1,\n    paddingHorizontal: 16,\n    paddingVertical: 12,\n  },\n  title: {\n    fontSize: 28,\n    fontWeight: 'bold',\n    color: '#000',\n    marginBottom: 4,\n  },\n  subtitle: {\n    fontSize: 14,\n    color: '#666',\n    marginBottom: 20,\n  },\n  imagePreviewContainer: {\n    marginBottom: 24,\n  },\n  imagePreview: {\n    width: '100%',\n    height: 300,\n    borderRadius: 12,\n    marginBottom: 12,\n    backgroundColor: '#f5f5f5',\n  },\n  imagePlaceholder: {\n    width: '100%',\n    height: 300,\n    borderRadius: 12,\n    backgroundColor: '#f5f5f5',\n    justifyContent: 'center',\n    alignItems: 'center',\n    marginBottom: 12,\n    borderWidth: 2,\n    borderColor: '#e0e0e0',\n    borderStyle: 'dashed',\n  },\n  placeholderText: {\n    fontSize: 48,\n    marginBottom: 8,\n  },\n  placeholderText2: {\n    fontSize: 14,\n    color: '#999',\n  },\n  selectImageButton: {\n    backgroundColor: '#007AFF',\n    paddingHorizontal: 16,\n    paddingVertical: 12,\n    borderRadius: 8,\n    alignItems: 'center',\n  },\n  selectImageButtonText: {\n    color: '#fff',\n    fontSize: 16,\n    fontWeight: '600',\n  },\n  section: {\n    marginBottom: 24,\n  },\n  sectionTitle: {\n    fontSize: 16,\n    fontWeight: '600',\n    color: '#000',\n    marginBottom: 12,\n  },\n  directionDisplay: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    paddingHorizontal: 16,\n    paddingVertical: 12,\n    backgroundColor: '#f5f5f5',\n    borderRadius: 8,\n  },\n  directionDisplayIcon: {\n    fontSize: 24,\n    marginRight: 12,\n  },\n  directionDisplayText: {\n    fontSize: 16,\n    color: '#000',\n  },\n  scaleOptions: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    marginBottom: 16,\n  },\n  scaleOption: {\n    flex: 1,\n    paddingHorizontal: 12,\n    paddingVertical: 10,\n    marginHorizontal: 4,\n    borderRadius: 8,\n    backgroundColor: '#f5f5f5',\n    borderWidth: 2,\n    borderColor: 'transparent',\n    alignItems: 'center',\n  },\n  scaleOptionSelected: {\n    backgroundColor: '#f0f7ff',\n    borderColor: '#007AFF',\n  },\n  scaleOptionText: {\n    fontSize: 14,\n    fontWeight: '600',\n    color: '#666',\n  },\n  scaleOptionTextSelected: {\n    color: '#007AFF',\n  },\n  customScaleContainer: {\n    paddingHorizontal: 12,\n    paddingVertical: 12,\n    backgroundColor: '#f5f5f5',\n    borderRadius: 8,\n  },\n  customScaleLabel: {\n    fontSize: 14,\n    fontWeight: '600',\n    color: '#000',\n    marginBottom: 8,\n  },\n  slider: {\n    width: '100%',\n    height: 40,\n  },\n  progressContainer: {\n    marginBottom: 24,\n    paddingHorizontal: 12,\n    paddingVertical: 16,\n    backgroundColor: '#f5f5f5',\n    borderRadius: 8,\n  },\n  progressText: {\n    fontSize: 14,\n    fontWeight: '600',\n    color: '#000',\n    marginBottom: 8,\n  },\n  progressBar: {\n    width: '100%',\n    height: 8,\n    backgroundColor: '#e0e0e0',\n    borderRadius: 4,\n    overflow: 'hidden',\n    marginBottom: 8,\n  },\n  progressFill: {\n    height: '100%',\n    backgroundColor: '#007AFF',\n  },\n  progressPercentage: {\n    fontSize: 12,\n    color: '#666',\n    textAlign: 'right',\n  },\n  resultContainer: {\n    marginBottom: 24,\n  },\n  resultTitle: {\n    fontSize: 16,\n    fontWeight: '600',\n    color: '#000',\n    marginBottom: 12,\n  },\n  resultImage: {\n    width: '100%',\n    height: 300,\n    borderRadius: 12,\n    marginBottom: 12,\n    backgroundColor: '#f5f5f5',\n  },\n  saveButton: {\n    backgroundColor: '#34C759',\n    paddingHorizontal: 16,\n    paddingVertical: 12,\n    borderRadius: 8,\n    alignItems: 'center',\n  },\n  saveButtonText: {\n    color: '#fff',\n    fontSize: 16,\n    fontWeight: '600',\n  },\n  generateButton: {\n    backgroundColor: '#007AFF',\n    paddingHorizontal: 16,\n    paddingVertical: 16,\n    borderRadius: 8,\n    alignItems: 'center',\n    marginBottom: 24,\n  },\n  generateButtonDisabled: {\n    opacity: 0.5,\n  },\n  generateButtonText: {\n    color: '#fff',\n    fontSize: 18,\n    fontWeight: '600',\n  },\n  modal: {\n    flex: 1,\n    backgroundColor: '#fff',\n  },\n  modalHeader: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    alignItems: 'center',\n    paddingHorizontal: 16,\n    paddingVertical: 12,\n    borderBottomWidth: 1,\n    borderBottomColor: '#e0e0e0',\n  },\n  modalTitle: {\n    fontSize: 18,\n    fontWeight: 'bold',\n    color: '#000',\n  },\n  closeButton: {\n    fontSize: 24,\n    color: '#666',\n  },\n  directionsGrid: {\n    flexDirection: 'row',\n    flexWrap: 'wrap',\n    paddingHorizontal: 8,\n    paddingVertical: 12,\n  },\n  directionItem: {\n    width: '25%',\n    paddingHorizontal: 8,\n    paddingVertical: 12,\n    alignItems: 'center',\n  },\n  directionItemSelected: {\n    backgroundColor: '#f0f7ff',\n    borderRadius: 8,\n  },\n  directionItemIcon: {\n    fontSize: 32,\n    marginBottom: 8,\n  },\n  directionItemName: {\n    fontSize: 12,\n    color: '#000',\n    textAlign: 'center',\n  },\n});\n
